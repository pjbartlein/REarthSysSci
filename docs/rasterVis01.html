<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Plots with raster and rasterVis</title>

<script src="site_libs/header-attrs-2.25/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="html-md-01.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">R for Earth-System Science</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="overview.html">Overview</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Lecture topics</li>
    <li>
      <a href="intro.html">Introduction: R, RStudio, and other infrastructure</a>
    </li>
    <li>
      <a href="usingR.html">Using R</a>
    </li>
    <li>
      <a href="ESSdata.html">Earth-system science data</a>
    </li>
    <li>
      <a href="netCDF.html">netCDF in R</a>
    </li>
    <li>
      <a href="raster_intro.html">raster and netCDF in R</a>
    </li>
    <li>
      <a href="hdf5_intro.html">HDF in R</a>
    </li>
    <li>
      <a href="geospatial.html">Geospatial analyses</a>
    </li>
    <li>
      <a href="RMaps.html">Maps in R</a>
    </li>
    <li>
      <a href="RMaps2.html">Maps in R (2)</a>
    </li>
    <li>
      <a href="rasterVis01.html">Visualization:  raster and rasterVis</a>
    </li>
    <li>
      <a href="vis_ggplot01.html">Visualization for explanation</a>
    </li>
    <li>
      <a href="highdim.html">Visualization of high-dimensional data</a>
    </li>
    <li>
      <a href="PCA.html">Principal components analysis</a>
    </li>
    <li>
      <a href="multivariate.html">Other multivariate analyses</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tasks
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="geog495_ex01.html">Install R and RStudio</a>
    </li>
    <li>
      <a href="packages-and-data.html">Install packages and data</a>
    </li>
    <li>
      <a href="GitHub.html">Git and GitHub</a>
    </li>
    <li>
      <a href="Ex_UsingR.html">Using R exercise</a>
    </li>
    <li>
      <a href="markdown.html">Markdown and RMarkdown</a>
    </li>
    <li>
      <a href="install_netCDF.html">Install netCDF</a>
    </li>
    <li>
      <a href="install_Panoply.html">Install Panoply</a>
    </li>
    <li>
      <a href="transfer.html">File transfer</a>
    </li>
    <li>
      <a href="project.html">GitHub project repository and web page</a>
    </li>
    <li>
      <a href="ltms-and-anomalies.html">Long-term means and anomalies</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Resources
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="readings.html">Readings</a>
    </li>
    <li>
      <a href="websites.html">Old course web pages</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="about.html">About</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Plots with raster and rasterVis</h1>

</div>

<div id="TOC">
<ul>
<li><a
href="#examples-of-the-use-of-the-raster-package-to-read-and-analyze-raster-data-sets"
id="toc-examples-of-the-use-of-the-raster-package-to-read-and-analyze-raster-data-sets"><span
class="toc-section-number">1</span> Examples of the use of the raster
package to read and analyze raster data sets</a>
<ul>
<li><a href="#preliminaries" id="toc-preliminaries"><span
class="toc-section-number">1.1</span> Preliminaries</a></li>
<li><a href="#reading-a-netcdf-file-using-the-raster-package"
id="toc-reading-a-netcdf-file-using-the-raster-package"><span
class="toc-section-number">1.2</span> Reading a netCDF file using the
raster package</a></li>
</ul></li>
<li><a href="#rastervis-style-small-multiple-maps"
id="toc-rastervis-style-small-multiple-maps"><span
class="toc-section-number">2</span> rasterVis-style small-multiple
maps</a></li>
<li><a href="#time-series-plots" id="toc-time-series-plots"><span
class="toc-section-number">3</span> Time-Series plots</a>
<ul>
<li><a href="#time-series-plot-of-consecutive-values"
id="toc-time-series-plot-of-consecutive-values"><span
class="toc-section-number">3.1</span> Time-series plot of consecutive
values</a></li>
<li><a href="#multi-panel-plot-of-monthly-time-series-data"
id="toc-multi-panel-plot-of-monthly-time-series-data"><span
class="toc-section-number">3.2</span> Multi-panel plot of monthly time
series data</a></li>
</ul></li>
<li><a href="#hovmöller-and-horizon-plots"
id="toc-hovmöller-and-horizon-plots"><span
class="toc-section-number">4</span> Hovmöller and horizon plots</a>
<ul>
<li><a href="#set-up" id="toc-set-up"><span
class="toc-section-number">4.1</span> Set up</a></li>
<li><a href="#hovmöller" id="toc-hovmöller"><span
class="toc-section-number">4.2</span> Hovmöller</a></li>
<li><a href="#horizon-plot" id="toc-horizon-plot"><span
class="toc-section-number">4.3</span> Horizon plot</a></li>
<li><a href="#hovmöller-plots-a-second-example"
id="toc-hovmöller-plots-a-second-example"><span
class="toc-section-number">4.4</span> Hovmöller plots – a second
example</a></li>
</ul></li>
</ul>
</div>

<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div
id="examples-of-the-use-of-the-raster-package-to-read-and-analyze-raster-data-sets"
class="section level1" number="1">
<h1><span class="header-section-number">1</span> Examples of the use of
the raster package to read and analyze raster data sets</h1>
<div id="preliminaries" class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Preliminaries</h2>
<p>The following files will be used here, and are available on the SFTP
server, in the folders /nc_files and /Rmaps:</p>
<ul>
<li><code>ne_110m_admin_0_countries.shp</code> — world coastline and
country borders</li>
<li><code>ne_110m_coastline.shp</code>— world coastlines</li>
<li><code>treecov.nc</code> — global UMD tree-cover data</li>
<li><code>cru_ts4.02.1961.1990.tmp.ltm.nc</code> — CRU monthly
temperature time series, long-term means</li>
<li><code>cru_ts4.02.1901.2017.tmp.anm.nc</code>— CRU monthly
temperature time series (1901-2017)</li>
<li><code>NOAA_ERSSTv5_sst.mnmean.nc</code> — NOAA SST monthly time
series (1854 - 2019)</li>
<li><code>NOAA_ERSSTv5_sst.mon.ltm.1981-2010.nc</code>— NOAA SST time
series, long-term means</li>
<li><code>HadCRUT.4.6.0.0.median.nc</code> — HadCRUtv4 — Hadley
Centre/CRU merged temperature anomalies, 1850-2019</li>
</ul>
<p>Download or copy the files to a “data folder” like
<code>"/Users/bartlein/Projects/ESSD/data/nc_files"</code>.</p>
<p>The following examples use functions from the <code>raster</code> and
<code>rasterVis</code> packages to read and display a few data sets. The
datasets used here happen to be stored as <code>netCDF</code> files, but
the <code>raster</code> package can also read and write other formats
that raster data are commonly stored in. The <code>raster</code> package
implements three basic objects or classes: 1) a
<code>rasterLayer</code>, which is a single 2-D, x-y array of values
(e.g. a DEM), 2) a <code>rasterStack</code>, a set of individual
co-registered (i.e. on the same grid) rasterLayer objects (usually
different variables), and 3) a <code>rasterBrick</code>, representing a
set of layers that make up 3-D data set of a particular variable, such
as a climate variable observed over time, or a set of bands in a multi-
or hyperspectral image. Individual layers can be assembled into a stack,
and can also be formed by extracting a 2-D slice from a raster
brick.</p>
<p>Load the appropriate packages (installing them first if they’re not
present, i.e. <code>install.packages("maptools")</code>:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(ncdf4)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="co"># library(ncdf.tools)</span></span>
<span id="cb1-3"><a href="#cb1-3" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb1-4"><a href="#cb1-4" tabindex="-1"></a><span class="fu">library</span>(rasterVis)</span>
<span id="cb1-5"><a href="#cb1-5" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span>
<span id="cb1-6"><a href="#cb1-6" tabindex="-1"></a></span>
<span id="cb1-7"><a href="#cb1-7" tabindex="-1"></a><span class="fu">library</span>(ggplot2)</span>
<span id="cb1-8"><a href="#cb1-8" tabindex="-1"></a><span class="fu">library</span>(ggthemes)</span>
<span id="cb1-9"><a href="#cb1-9" tabindex="-1"></a></span>
<span id="cb1-10"><a href="#cb1-10" tabindex="-1"></a><span class="fu">library</span>(zoo)</span>
<span id="cb1-11"><a href="#cb1-11" tabindex="-1"></a><span class="fu">library</span>(sf)</span></code></pre></div>
<p>For subsequent use, read the world country-outlines shape file:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a>shp_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/shp_files/ne_110m_admin_0_countries/&quot;</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>shp_name <span class="ot">&lt;-</span> <span class="st">&quot;ne_110m_admin_0_countries.shp&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>shp_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(shp_path, shp_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a></span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a><span class="co"># read the shapefile</span></span>
<span id="cb2-6"><a href="#cb2-6" tabindex="-1"></a>world_shp <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(shp_file)</span>
<span id="cb2-7"><a href="#cb2-7" tabindex="-1"></a>world_outline <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">st_geometry</span>(world_shp), <span class="at">Class=</span><span class="st">&quot;Spatial&quot;</span>)</span>
<span id="cb2-8"><a href="#cb2-8" tabindex="-1"></a></span>
<span id="cb2-9"><a href="#cb2-9" tabindex="-1"></a><span class="co"># plot the outline</span></span>
<span id="cb2-10"><a href="#cb2-10" tabindex="-1"></a><span class="fu">plot</span>(world_outline, <span class="at">col=</span><span class="st">&quot;gray80&quot;</span>, <span class="at">lwd=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="rasterVis01_files/figure-html/readWorldFake-1.png" width="75%" height="75%" /></p>
</div>
<div id="reading-a-netcdf-file-using-the-raster-package"
class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Reading a netCDF file
using the raster package</h2>
<p>Read a single-variable netCDF dataset describing global tree cover
using the <code>raster()</code> function, which operates on a filename.
Individual characteristics of the data can be displayed using some
utility functions.</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="co"># read a single-variable netCDF dataset using raster()</span></span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a>tree_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb3-3"><a href="#cb3-3" tabindex="-1"></a>tree_name <span class="ot">&lt;-</span> <span class="st">&quot;treecov.nc&quot;</span></span>
<span id="cb3-4"><a href="#cb3-4" tabindex="-1"></a>tree_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(tree_path, tree_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb3-5"><a href="#cb3-5" tabindex="-1"></a>tree <span class="ot">&lt;-</span> <span class="fu">raster</span>(tree_file) <span class="co"># open treecov.nc</span></span></code></pre></div>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">print</span>(tree) <span class="co"># netCDF info</span></span></code></pre></div>
<pre><code>## File /Users/bartlein/Projects/ESSD/data/nc_files/treecov.nc (NC_FORMAT_CLASSIC):
## 
##      1 variables (excluding dimension variables):
##         float treecov[lon,lat]   
##             name: treecov
##             long_name: treecov
##             units: 1
##             _FillValue: -9
## 
##      2 dimensions:
##         lon  Size:720 
##             standard_name: longitude
##             long_name: longitude
##             units: degrees_east
##             axis: X
##         lat  Size:360 
##             standard_name: latitude
##             long_name: latitude
##             units: degrees_north
##             axis: Y
## 
##     3 global attributes:
##         source: UMD Tree Cover Data resampled to 0.5-degrees
##         data: gl-latlong-8km-landcover.bsq.gz
##         history: P.J. Bartlein, 20 Feb 2008</code></pre>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a>tree <span class="co"># raster info</span></span></code></pre></div>
<pre><code>## class      : RasterLayer 
## dimensions : 360, 720, 259200  (nrow, ncol, ncell)
## resolution : 0.5, 0.5  (x, y)
## extent     : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +no_defs 
## source     : treecov.nc 
## names      : treecov 
## zvar       : treecov</code></pre>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">filename</span>(tree), <span class="fu">hasValues</span>(tree), <span class="fu">inMemory</span>(tree)))</span></code></pre></div>
<pre><code>## [1] &quot;/Users/bartlein/Projects/ESSD/data/nc_files/treecov.nc&quot;
## [2] &quot;TRUE&quot;                                                  
## [3] &quot;FALSE&quot;</code></pre>
<p>In the above example, the <code>raster()</code> function opens the
netCDF file, and creates a raster object (<code>tree</code>). Printing
this object using the <code>print()</code> function displays the netCDF
metadata (or “attributes”), while simply “typing” the object name
displays the attributes of the <code>raster</code> object. The functions
<code>filename()</code>, <code>hasValues()</code> and
<code>inMemory()</code> display the filename of the object, whether it
currently contains values, and whether it is stored in memory, or still
resides on disk. In this case, the data in the file
<code>/Users/bartlein/Projects/ESSD/data/nc_files/treecov.nc</code>
still resides on disk (<code>inMemory(tree) = FALSE</code>).</p>
<p>The range of <code>tree</code> (tree cover) can be gotten with the
<code>cellStats()</code> function. Values less than 0.0 indicate barren
land-surfac cover, and these values can be recoded to be equal to
0.0.</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">cellStats</span>(tree,<span class="at">stat=</span><span class="st">&#39;min&#39;</span>), <span class="fu">cellStats</span>(tree,<span class="at">stat=</span><span class="st">&#39;max&#39;</span>)))</span></code></pre></div>
<pre><code>## [1] -2 80</code></pre>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>tree[tree <span class="sc">&lt;</span> <span class="dv">0</span>] <span class="ot">&lt;-</span> <span class="dv">0</span></span></code></pre></div>
<p>Next, a basic plot of the data can be generated using the
<code>levelplot()</code> function. (The <code>rasterVis</code> package
implements a number of Lattice-type plots for raster data sets.)</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># basic plot</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a><span class="fu">levelplot</span>(tree)</span></code></pre></div>
<p><img src="rasterVis01_files/figure-html/rstr06-1.png" width="75%" height="75%" /></p>
<p>A better map can be genrated by setting a <code>rasterTheme</code>
(in this case a progressive color scale of green from the
<code>RColorBrewer</code> palette), generating the
<code>levelplot()</code> object, and then adding a layer to the plot
consisting of the countru outlines (<code>world.shp</code>).</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a><span class="co"># plot with outlines, a better color scale, no marginal plots</span></span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a>mapTheme <span class="ot">&lt;-</span> <span class="fu">rasterTheme</span>(<span class="at">region=</span><span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&quot;Greens&quot;</span>))</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(tree, <span class="at">margin=</span>F, <span class="at">par.settings=</span>mapTheme)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>plt <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">layer</span>(<span class="fu">sp.lines</span>(world_outline, <span class="at">col=</span><span class="st">&quot;gray30&quot;</span>, <span class="at">lwd=</span><span class="fl">0.5</span>))</span></code></pre></div>
<p><img src="rasterVis01_files/figure-html/rstr07-1.png" width="75%" height="75%" /></p>
<p>Notice in the code above the specification of the
<code>layer()</code> function as <code>latticeExtra::layer()</code>.
This distinguishes betwee the layer function in the the
<code>latticeExtra</code> package from that in <code>ggplot2</code>.</p>
<p>Here is another version, with outlines, a better color scale, and
“marginal plots”.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a><span class="co"># plot with outlines, a better color scale, marginal plots</span></span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>mapTheme <span class="ot">&lt;-</span> <span class="fu">rasterTheme</span>(<span class="at">region=</span><span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&quot;Greens&quot;</span>))</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(tree, <span class="at">margin=</span>T, <span class="at">par.settings=</span>mapTheme)</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a>plt <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">layer</span>(<span class="fu">sp.lines</span>(world_outline, <span class="at">col=</span><span class="st">&quot;gray30&quot;</span>, <span class="at">lwd=</span><span class="fl">0.5</span>))</span></code></pre></div>
<p><img src="rasterVis01_files/figure-html/rstr08-1.png" width="75%" height="75%" /></p>
<p><a href="rasterVis01.html">[Back to top]</a></p>
</div>
</div>
<div id="rastervis-style-small-multiple-maps" class="section level1"
number="2">
<h1><span class="header-section-number">2</span> rasterVis-style
small-multiple maps</h1>
<p>Small-multiple maps consist of an array of maps, each with the same
cooridinate system, that can be used, for example, to plot long-term
mean values for individual maps. Here, the long-term means of CRU TS
4.02 near-surface air temperature data will be plotted. First, read in
another shapefile, with only coastlines.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="co"># set path and shape file name</span></span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a>coast_shp_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/RMaps/source/ne_110m_coastline/&quot;</span></span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a>coast_shp_name <span class="ot">&lt;-</span> <span class="st">&quot;ne_110m_coastline.shp&quot;</span></span>
<span id="cb16-4"><a href="#cb16-4" tabindex="-1"></a>coast_shp_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(coast_shp_path, coast_shp_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb16-5"><a href="#cb16-5" tabindex="-1"></a></span>
<span id="cb16-6"><a href="#cb16-6" tabindex="-1"></a><span class="co"># read the shapefile</span></span>
<span id="cb16-7"><a href="#cb16-7" tabindex="-1"></a>coast_shp <span class="ot">&lt;-</span> <span class="fu">read_sf</span>(coast_shp_file)</span>
<span id="cb16-8"><a href="#cb16-8" tabindex="-1"></a>coast_outline <span class="ot">&lt;-</span> <span class="fu">as</span>(<span class="fu">st_geometry</span>(coast_shp), <span class="at">Class=</span><span class="st">&quot;Spatial&quot;</span>)</span>
<span id="cb16-9"><a href="#cb16-9" tabindex="-1"></a></span>
<span id="cb16-10"><a href="#cb16-10" tabindex="-1"></a><span class="co"># plot the outline</span></span>
<span id="cb16-11"><a href="#cb16-11" tabindex="-1"></a><span class="fu">plot</span>(coast_outline, <span class="at">col=</span><span class="st">&quot;gray50&quot;</span>, <span class="at">lwd=</span><span class="dv">1</span>)</span></code></pre></div>
<p><img src="rasterVis01_files/figure-html/readCoast-1.png" width="75%" height="75%" /></p>
<p>Set the path, file, and variable names for the CRU data:</p>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># path and file name, set dname</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>ncpath <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>ncname <span class="ot">&lt;-</span> <span class="st">&quot;cru_ts4.02.1961.1990.tmp.ltm.nc&quot;</span>   </span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>ncfname <span class="ot">&lt;-</span> <span class="fu">paste</span>(ncpath, ncname, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb17-5"><a href="#cb17-5" tabindex="-1"></a>dname <span class="ot">&lt;-</span> <span class="st">&quot;tmp_ltm&quot;</span>  <span class="co"># note: tmp means temperature (not temporary)</span></span></code></pre></div>
<p>Read the CRU data as a raster stack:</p>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># read a raster stack</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>CRU_tmp_ltm <span class="ot">&lt;-</span> <span class="fu">stack</span>(ncfname)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a>CRU_tmp_ltm</span></code></pre></div>
<pre><code>## class      : RasterStack 
## dimensions : 360, 720, 259200, 12  (nrow, ncol, ncell, nlayers)
## resolution : 0.5, 0.5  (x, y)
## extent     : -180, 180, -90, 90  (xmin, xmax, ymin, ymax)
## crs        : +proj=longlat +datum=WGS84 +no_defs 
## names      : X1976.01.16, X1976.02.15, X1976.03.16, X1976.04.16, X1976.05.16, X1976.06.16, X1976.07.16, X1976.08.16, X1976.09.16, X1976.10.16, X1976.11.16, X1976.12.16</code></pre>
<p>Replace the cryptic names in the raster stack with the names of
months:</p>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># replace layer names</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a><span class="fu">names</span>(CRU_tmp_ltm) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Jan&quot;</span>,<span class="st">&quot;Feb&quot;</span>,<span class="st">&quot;Mar&quot;</span>,<span class="st">&quot;Apr&quot;</span>,<span class="st">&quot;May&quot;</span>,<span class="st">&quot;Jun&quot;</span>,<span class="st">&quot;Jul&quot;</span>,<span class="st">&quot;Aug&quot;</span>,<span class="st">&quot;Sep&quot;</span>,<span class="st">&quot;Oct&quot;</span>,<span class="st">&quot;Nov&quot;</span>,<span class="st">&quot;Dec&quot;</span>)</span></code></pre></div>
<p>Create a <code>rasterVis</code> lattice-style levelplot. The plot
will be rather large and time-consuming to plot, and so a more efficient
way to produce it is to write it directly to a <code>.png</code> file.
This is accomplished by braketing the necessary code for the levelplot
with code to open a <code>.png</code> file:</p>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a><span class="co"># lattice-style levelplot</span></span>
<span id="cb21-2"><a href="#cb21-2" tabindex="-1"></a>pngfile <span class="ot">&lt;-</span> <span class="st">&quot;CRU_tmp_ltm.png&quot;</span></span>
<span id="cb21-3"><a href="#cb21-3" tabindex="-1"></a><span class="fu">png</span>(pngfile, <span class="at">width=</span><span class="dv">729</span>, <span class="at">height=</span><span class="dv">729</span>) <span class="co"># open the file</span></span>
<span id="cb21-4"><a href="#cb21-4" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">50</span>,<span class="sc">-</span><span class="dv">40</span>,<span class="sc">-</span><span class="dv">30</span>,<span class="sc">-</span><span class="dv">20</span>,<span class="sc">-</span><span class="dv">10</span>,<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>)</span>
<span id="cb21-5"><a href="#cb21-5" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(CRU_tmp_ltm , <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb21-6"><a href="#cb21-6" tabindex="-1"></a>          <span class="at">col.regions=</span>(<span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">10</span>,<span class="st">&quot;RdBu&quot;</span>))))</span>
<span id="cb21-7"><a href="#cb21-7" tabindex="-1"></a>plt <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">layer</span>(<span class="fu">sp.lines</span>(coast_outline, <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">lwd=</span><span class="fl">0.5</span>))</span>
<span id="cb21-8"><a href="#cb21-8" tabindex="-1"></a><span class="co">#dev.off() # close the file</span></span></code></pre></div>
<p>Here’s what the image looks like:</p>
<p><img src="CRU_tmp_ltm.png" /></p>
</div>
<div id="time-series-plots" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Time-Series plots</h1>
<p>A basic way of visualizing data in, for example, a 3-D netCDF file,
with time being the third dimension, is to plot time series of
individual grid points or areal averages. Here we’ll plot the CRU
temperature data for the grid point closest to Eugene, both as a single
time series with the monthly values in consecutive order, and in a
multi-panel plot, with the data for each month of the year in a differnt
panel. Begin by setting the path, file, and variable names:</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># path and file name, set dname</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a>ncpath <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb22-3"><a href="#cb22-3" tabindex="-1"></a>ncname <span class="ot">&lt;-</span> <span class="st">&quot;cru_ts4.02.1901.2017.tmp.anm.nc&quot;</span>   </span>
<span id="cb22-4"><a href="#cb22-4" tabindex="-1"></a>ncfname <span class="ot">&lt;-</span> <span class="fu">paste</span>(ncpath, ncname, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb22-5"><a href="#cb22-5" tabindex="-1"></a>dname <span class="ot">&lt;-</span> <span class="st">&quot;tmp_anm&quot;</span>  <span class="co"># note: tmp means temperature (not temporary)</span></span></code></pre></div>
<p>Open the netCDF file</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># open a netCDF file</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>ncin <span class="ot">&lt;-</span> <span class="fu">nc_open</span>(ncfname)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a><span class="fu">print</span>(ncin)</span></code></pre></div>
<pre><code>## File /Users/bartlein/Projects/ESSD/data/nc_files/cru_ts4.02.1901.2017.tmp.anm.nc (NC_FORMAT_NETCDF4):
## 
##      1 variables (excluding dimension variables):
##         float tmp_anm[lon,lat,time]   (Contiguous storage)  
##             units: degrees Celsius
##             _FillValue: 9.96920996838687e+36
##             long_name: near-surface air temperature anomalies
##             base_period: 1961 - 1990
## 
##      3 dimensions:
##         lon  Size:720 
##             units: degrees_east
##             long_name: lon
##             axis: X
##         lat  Size:360 
##             units: degrees_north
##             long_name: lat
##             axis: Y
##         time  Size:1404 
##             units: days since 1900-1-1
##             long_name: time
##             axis: T
## 
##     6 global attributes:
##         title: CRU TS4.02 Mean Temperature
##         institution: Data held at British Atmospheric Data Centre, RAL, UK.
##         source: Run ID = 1811131722. Data generated from:tmp.1804231108.dtb
##         references: Information on the data is available at http://badc.nerc.ac.uk/data/cru/
##         history: P.J. Bartlein, Thu May 16 08:57:21 2019
##         Conventions: CF-1.4</code></pre>
<p>Get longitude, latitude and time:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a><span class="co"># get longitude and latitude</span></span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lon&quot;</span>)</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>nlon <span class="ot">&lt;-</span> <span class="fu">dim</span>(lon)</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="fu">head</span>(lon)</span></code></pre></div>
<pre><code>## [1] -179.75 -179.25 -178.75 -178.25 -177.75 -177.25</code></pre>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lat&quot;</span>)</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>nlat <span class="ot">&lt;-</span> <span class="fu">dim</span>(lat)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a><span class="fu">head</span>(lat)</span></code></pre></div>
<pre><code>## [1] -89.75 -89.25 -88.75 -88.25 -87.75 -87.25</code></pre>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># get time</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;time&quot;</span>)</span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a><span class="co"># time # uncomment to see individual times</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>tunits <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>nt <span class="ot">&lt;-</span> <span class="fu">dim</span>(time)</span>
<span id="cb29-6"><a href="#cb29-6" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(nlon, nlat, nt))</span></code></pre></div>
<pre><code>## [1]  720  360 1404</code></pre>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a>tunits</span></code></pre></div>
<pre><code>## $hasatt
## [1] TRUE
## 
## $value
## [1] &quot;days since 1900-1-1&quot;</code></pre>
<p>Get the array of time series data:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># get temperature</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>tmp_array <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,dname)</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>dlname <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname,<span class="st">&quot;long_name&quot;</span>)</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a>dunits <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a>fillvalue <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname,<span class="st">&quot;_FillValue&quot;</span>)</span>
<span id="cb33-6"><a href="#cb33-6" tabindex="-1"></a><span class="fu">dim</span>(tmp_array)</span></code></pre></div>
<pre><code>## [1]  720  360 1404</code></pre>
<p>Convert the time variable from the <em>CF-Conventions</em>
“time-since” format to a more conventional form:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a><span class="co"># convert time -- split the time units string into fields</span></span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="co"># convert time -- split the time units string into fields</span></span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a>tustr <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(tunits<span class="sc">$</span>value, <span class="st">&quot; &quot;</span>)</span>
<span id="cb35-4"><a href="#cb35-4" tabindex="-1"></a>ptime <span class="ot">&lt;-</span> <span class="fu">convertDateNcdf2R</span>(time, <span class="fu">unlist</span>(tustr)[<span class="dv">1</span>], </span>
<span id="cb35-5"><a href="#cb35-5" tabindex="-1"></a>  <span class="at">origin =</span>  <span class="fu">as.POSIXct</span>(<span class="fu">unlist</span>(tustr)[<span class="dv">3</span>], <span class="at">tz =</span> <span class="st">&quot;UTC&quot;</span>), <span class="at">time.format =</span> <span class="st">&quot;%Y-%m-%d&quot;</span>)</span>
<span id="cb35-6"><a href="#cb35-6" tabindex="-1"></a><span class="fu">head</span>(time); <span class="fu">tail</span>(time)</span>
<span id="cb35-7"><a href="#cb35-7" tabindex="-1"></a><span class="fu">head</span>(ptime); <span class="fu">tail</span>(ptime)</span></code></pre></div>
<p>Get the beginning and ending year of the time series:</p>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="co"># get beginning year and ending year, number of years, and set nm</span></span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a>beg_date <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">as.character</span>(ptime[<span class="dv">1</span>]), <span class="st">&quot; &quot;</span>)</span>
<span id="cb36-3"><a href="#cb36-3" tabindex="-1"></a>beg_yr <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">as.character</span>(beg_date), <span class="st">&quot;-&quot;</span>))[<span class="dv">1</span>])</span>
<span id="cb36-4"><a href="#cb36-4" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">as.character</span>(ptime[nt]), <span class="st">&quot; &quot;</span>)</span>
<span id="cb36-5"><a href="#cb36-5" tabindex="-1"></a>end_yr <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">as.character</span>(end_date), <span class="st">&quot;-&quot;</span>))[<span class="dv">1</span>])</span>
<span id="cb36-6"><a href="#cb36-6" tabindex="-1"></a>nyrs <span class="ot">&lt;-</span> end_yr <span class="sc">-</span> beg_yr <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb36-7"><a href="#cb36-7" tabindex="-1"></a>nm <span class="ot">&lt;-</span> <span class="dv">12</span></span>
<span id="cb36-8"><a href="#cb36-8" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(beg_yr, end_yr, nyrs, nm))</span></code></pre></div>
<p>Generate a decimal year value for plotting consecutive values:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># generate a decimal year (&quot;YrMn&quot;) time coordinate</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>YrMn <span class="ot">&lt;-</span> <span class="fu">seq</span>(beg_yr, end_yr<span class="sc">+</span><span class="dv">1</span><span class="sc">-</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>), <span class="at">by=</span>(<span class="dv">1</span><span class="sc">/</span><span class="dv">12</span>))</span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a><span class="fu">head</span>(YrMn); <span class="fu">tail</span>(YrMn)</span></code></pre></div>
<p>Generate year and month values for creating the dataframe that will
be used to get multi-panel plots:</p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a><span class="co"># year</span></span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>year <span class="ot">&lt;-</span> <span class="fu">as.integer</span>(YrMn)</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="fu">head</span>(year); <span class="fu">tail</span>(year)</span>
<span id="cb38-4"><a href="#cb38-4" tabindex="-1"></a></span>
<span id="cb38-5"><a href="#cb38-5" tabindex="-1"></a><span class="co"># month</span></span>
<span id="cb38-6"><a href="#cb38-6" tabindex="-1"></a><span class="co"># month &lt;- rep(seq(1, 12, by=1), nyrs)</span></span>
<span id="cb38-7"><a href="#cb38-7" tabindex="-1"></a>month_names <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Jan&quot;</span>,<span class="st">&quot;Feb&quot;</span>,<span class="st">&quot;Mar&quot;</span>,<span class="st">&quot;Apr&quot;</span>,<span class="st">&quot;May&quot;</span>,<span class="st">&quot;Jun&quot;</span>,<span class="st">&quot;Jul&quot;</span>,<span class="st">&quot;Aug&quot;</span>,<span class="st">&quot;Sep&quot;</span>,<span class="st">&quot;Oct&quot;</span>,<span class="st">&quot;Nov&quot;</span>, <span class="st">&quot;Dec&quot;</span>)</span>
<span id="cb38-8"><a href="#cb38-8" tabindex="-1"></a>month <span class="ot">&lt;-</span> <span class="fu">rep</span>(month_names, nyrs)</span>
<span id="cb38-9"><a href="#cb38-9" tabindex="-1"></a><span class="fu">head</span>(month); <span class="fu">tail</span>(month)</span>
<span id="cb38-10"><a href="#cb38-10" tabindex="-1"></a>month <span class="ot">&lt;-</span> <span class="fu">factor</span>(month, <span class="at">levels=</span><span class="fu">c</span>( <span class="st">&quot;Dec&quot;</span>, <span class="st">&quot;Jan&quot;</span>,<span class="st">&quot;Feb&quot;</span>,<span class="st">&quot;Mar&quot;</span>,<span class="st">&quot;Apr&quot;</span>,<span class="st">&quot;May&quot;</span>,<span class="st">&quot;Jun&quot;</span>,<span class="st">&quot;Jul&quot;</span>,<span class="st">&quot;Aug&quot;</span>,<span class="st">&quot;Sep&quot;</span>,<span class="st">&quot;Oct&quot;</span>,<span class="st">&quot;Nov&quot;</span>))</span>
<span id="cb38-11"><a href="#cb38-11" tabindex="-1"></a><span class="fu">str</span>(month)</span></code></pre></div>
<p>Note that <code>month</code> is a factor, and without intervention,
the monthly panels will plot in the default order for a factor:
alphabetical. This would be a little counterintuitive to interpret, but
the factor order can be reset using the code fragment:<br />
<code>month &lt;- factor(month, levels=month_names)</code>, as was done
above.</p>
<p>Now find the grid cell closest to Eugene (approximatly 123.1167 W and
44.08333 N). This is done by using the <code>which.min()</code>
function:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="co"># get indices of the grid cell closest to Eugene</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>tlon <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">123.1167</span>; tlat <span class="ot">&lt;-</span> <span class="fl">44.0833</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(lon<span class="sc">-</span>tlon))</span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(lat<span class="sc">-</span>tlat))</span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(j, lon[j], k, lat[k]))</span></code></pre></div>
<div id="time-series-plot-of-consecutive-values" class="section level2"
number="3.1">
<h2><span class="header-section-number">3.1</span> Time-series plot of
consecutive values</h2>
<p>The data in the netCDF file are arranged in consecutive order, and so
this is straightforward:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="co"># get time series for the closest gridpoint</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>tmp_ts <span class="ot">&lt;-</span> tmp_array[j, k, ]</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a></span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="co"># plot time series of grid point</span></span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a><span class="fu">plot</span>(YrMn, tmp_ts, <span class="at">type=</span><span class="st">&quot;l&quot;</span>, <span class="at">xlab=</span><span class="st">&quot;Year&quot;</span>, <span class="at">ylab=</span>dname, <span class="at">main=</span>dlname<span class="sc">$</span>value, <span class="at">col=</span><span class="st">&quot;red&quot;</span>)</span></code></pre></div>
</div>
<div id="multi-panel-plot-of-monthly-time-series-data"
class="section level2" number="3.2">
<h2><span class="header-section-number">3.2</span> Multi-panel plot of
monthly time series data</h2>
<p>Now make a dataframe consisting of <code>nt</code> values of the
<code>YrMn</code> variable, the temperature time series
<code>tmp_ts</code>, and the <code>year</code> and <code>month</code>
variables generated above:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="co"># make dataframe</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>tmp_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(YrMn, year, month, tmp_ts)</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a><span class="fu">str</span>(tmp_df)</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="fu">head</span>(tmp_df); <span class="fu">tail</span>(tmp_df)</span></code></pre></div>
<p>Now, construct a <code>ggplot2</code> multi-panel (e.g. “faceted”)
plot. The plot will be constructed with a lowess-smoother line in the
background, overplotted by the annual values of each month in a separate
panel.</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> tmp_df, <span class="fu">aes</span>(<span class="at">x=</span>year, <span class="at">y=</span>tmp_ts)) <span class="sc">+</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a>  <span class="co"># geom_smooth(method = &quot;lm&quot;, size=2, color=&quot;pink&quot;) +</span></span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">size=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;purple&quot;</span>) <span class="sc">+</span></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>  <span class="fu">facet_grid</span>(month <span class="sc">~</span> .)  </span></code></pre></div>
<p>The plot seems quite wide relative to the vertical space occupied by
each monthly time series, which makes it difficult to notice any trends
in the daa. The aspect of the ratio can be adjusted, guided by the Bill
Cleveland’s notion of “banking to 45 (degrees)”. The function
<code>bank_slopes()</code> in the package <code>ggthemes</code> can find
the aspect ratio that optimizes that notion for a single time series
(here, the values for December):</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="fu">bank_slopes</span>(tmp_df<span class="sc">$</span>year[tmp_df<span class="sc">$</span>month <span class="sc">==</span> <span class="st">&quot;Dec&quot;</span>], tmp_df<span class="sc">$</span>tmp_ts[tmp_df<span class="sc">$</span>month <span class="sc">==</span> <span class="st">&quot;Dec&quot;</span>])</span></code></pre></div>
<p>A good first-guess aspect ratio can then be found by multiplying this
value by the number of panels. However, experience shows that
multiplying by the half the number of panels provides a more pleasing
result:</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="fu">ggplot</span>(<span class="at">data =</span> tmp_df, <span class="fu">aes</span>(<span class="at">x=</span>year, <span class="at">y=</span>tmp_ts)) <span class="sc">+</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>  <span class="co"># geom_smooth(method = &quot;lm&quot;, size=2, color=&quot;pink&quot;) +</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>  <span class="fu">geom_smooth</span>(<span class="at">method =</span> <span class="st">&quot;loess&quot;</span>, <span class="at">size=</span><span class="fl">0.5</span>, <span class="at">color=</span><span class="st">&quot;purple&quot;</span>) <span class="sc">+</span></span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>  <span class="fu">geom_line</span>() <span class="sc">+</span> </span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>  <span class="fu">facet_grid</span>(month <span class="sc">~</span> .)  <span class="sc">+</span> </span>
<span id="cb44-6"><a href="#cb44-6" tabindex="-1"></a>  <span class="fu">theme</span>(<span class="at">aspect.ratio =</span> (<span class="fl">0.04</span> <span class="sc">*</span> (nm<span class="sc">/</span><span class="dv">2</span>)))</span></code></pre></div>
<p><a href="rasterVis01.html">[Back to top]</a></p>
</div>
</div>
<div id="hovmöller-and-horizon-plots" class="section level1" number="4">
<h1><span class="header-section-number">4</span> Hovmöller and horizon
plots</h1>
<p>The <code>rasterVis</code> package provides a couple of interesting
<code>Lattice</code>-type plots that can be used to visualize 3-D data
(usually a function of latitude, longitude and time). The Hovmöller plot
is a 2-D time/space diagram, where, for example, zonal (E-W) or
meridional (N-S) averages are plotted relative to time. The horizon plot
plots multiple time series (here average values for individual
latitudinal zones) in a way that allows common trends to be
visualized.</p>
<p>The data set used here is the NOAA Extended Sea-Surface Temperature
(SST) data. There is considerable set up to do first, which illustrates
some of the necessary data wrangling the goes on before a visualization
can be constructed. First the “observed” monthly values are read, then
the long-term means, and then anomalies are calculated. The data are
read using the <code>ncdf4</code> packages, which allows more
flexibility in reading the data than does the <code>raster</code>
package, and the resulting array is converted to a raster brick before
plotting.</p>
<div id="set-up" class="section level2" number="4.1">
<h2><span class="header-section-number">4.1</span> Set up</h2>
<p>Read the SST data:</p>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="co"># read SST data</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>SST_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a>SST_mon_name <span class="ot">&lt;-</span> <span class="st">&quot;NOAA_ERSSTv5_sst.mnmean.nc&quot;</span></span>
<span id="cb45-4"><a href="#cb45-4" tabindex="-1"></a>SST_mon_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(SST_path, SST_mon_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb45-5"><a href="#cb45-5" tabindex="-1"></a>dname_mon <span class="ot">&lt;-</span> <span class="st">&quot;sst&quot;</span></span>
<span id="cb45-6"><a href="#cb45-6" tabindex="-1"></a>ncin <span class="ot">&lt;-</span> <span class="fu">nc_open</span>(SST_mon_file)</span>
<span id="cb45-7"><a href="#cb45-7" tabindex="-1"></a><span class="co"># print(ncin) # uncomment to see full ncdump-style listing</span></span></code></pre></div>
<p>Get longitude, latitudes and time:</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="co"># get longitude and latitude</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lon&quot;</span>)</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>nlon <span class="ot">&lt;-</span> <span class="fu">dim</span>(lon)</span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a><span class="fu">head</span>(lon)</span>
<span id="cb46-5"><a href="#cb46-5" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lat&quot;</span>)</span>
<span id="cb46-6"><a href="#cb46-6" tabindex="-1"></a>nlat <span class="ot">&lt;-</span> <span class="fu">dim</span>(lat)</span>
<span id="cb46-7"><a href="#cb46-7" tabindex="-1"></a><span class="fu">head</span>(lat)</span>
<span id="cb46-8"><a href="#cb46-8" tabindex="-1"></a></span>
<span id="cb46-9"><a href="#cb46-9" tabindex="-1"></a><span class="co"># get time</span></span>
<span id="cb46-10"><a href="#cb46-10" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;time&quot;</span>)</span>
<span id="cb46-11"><a href="#cb46-11" tabindex="-1"></a>tunits <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb46-12"><a href="#cb46-12" tabindex="-1"></a>nt <span class="ot">&lt;-</span> <span class="fu">dim</span>(time)</span>
<span id="cb46-13"><a href="#cb46-13" tabindex="-1"></a><span class="fu">print</span> (<span class="fu">c</span>(nlon, nlat, nt))</span>
<span id="cb46-14"><a href="#cb46-14" tabindex="-1"></a>tunits</span></code></pre></div>
<p>Note that longitudes run from 0 to 360 degrees E, while latitudes run
from 90 N to 90 S. The the N to S layout of latitudes (and of the data)
will require various flipping of data arrays later.</p>
<p>Convert time:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="co"># convert time -- split the time units string into fields</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>tustr <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(tunits<span class="sc">$</span>value, <span class="st">&quot; &quot;</span>)</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>ptime <span class="ot">&lt;-</span> <span class="fu">convertDateNcdf2R</span>(time, <span class="fu">unlist</span>(tustr)[<span class="dv">1</span>], </span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>  <span class="at">origin =</span> <span class="fu">as.POSIXct</span>(<span class="fu">unlist</span>(tustr)[<span class="dv">3</span>],                                                <span class="at">tz =</span> <span class="st">&quot;UTC&quot;</span>), <span class="at">time.format =</span> <span class="st">&quot;%Y-%m-%d&quot;</span>)</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a><span class="fu">head</span>(time); <span class="fu">tail</span>(time)</span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a><span class="fu">head</span>(ptime); <span class="fu">tail</span>(ptime)</span></code></pre></div>
<p>Now get the SST data</p>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co"># get monthly SSTs</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>SST_mon <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,dname_mon)</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>dlname_mon <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname_mon,<span class="st">&quot;long_name&quot;</span>)</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>dunits_mon <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname_mon,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a>fillvalue_mon <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname_mon,<span class="st">&quot;_FillValue&quot;</span>)</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a><span class="fu">dim</span>(SST_mon)</span></code></pre></div>
<p>Close the netCDF file:</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="co"># close the monthly data file</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="fu">nc_close</span>(ncin)</span></code></pre></div>
<p>Flip the latitudes and data so that the data are layed out with the
origin in the “lower left” of the map:</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="co"># flip N-S</span></span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>temp_lat <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, nlat)</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>temp_lat[<span class="dv">1</span><span class="sc">:</span>nlat] <span class="ot">&lt;-</span> lat[nlat<span class="sc">:</span><span class="dv">1</span>]</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a>temp_lat</span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>lat <span class="ot">&lt;-</span> temp_lat</span>
<span id="cb50-6"><a href="#cb50-6" tabindex="-1"></a></span>
<span id="cb50-7"><a href="#cb50-7" tabindex="-1"></a>temp_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(nlon, nlat, nt))</span>
<span id="cb50-8"><a href="#cb50-8" tabindex="-1"></a>temp_array[<span class="dv">1</span><span class="sc">:</span>nlon, <span class="dv">1</span><span class="sc">:</span>nlat, <span class="dv">1</span><span class="sc">:</span>nt] <span class="ot">&lt;-</span>  SST_mon[<span class="dv">1</span><span class="sc">:</span>nlon, nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nt] </span>
<span id="cb50-9"><a href="#cb50-9" tabindex="-1"></a>SST_mon <span class="ot">&lt;-</span> temp_array</span></code></pre></div>
<p>Note that in many cases, it’s desireable to have longitudes run from
-180 to 180. This could be done by using the following code, but in the
current example, this is NOT done to facilitate looking at plots focused
on the Pacific.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="co"># rotate 0 to 360 to -180 to +180</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>temp_lon <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, nlon)</span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>temp_lon[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>)] <span class="ot">&lt;-</span>  lon[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon] <span class="sc">-</span> <span class="fl">360.0</span></span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a>temp_lon[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon] <span class="ot">&lt;-</span>  lon[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>)]</span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>temp_lon</span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a>lon <span class="ot">&lt;-</span> temp_lon</span>
<span id="cb51-7"><a href="#cb51-7" tabindex="-1"></a></span>
<span id="cb51-8"><a href="#cb51-8" tabindex="-1"></a>temp_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(nlon, nlat, nt))</span>
<span id="cb51-9"><a href="#cb51-9" tabindex="-1"></a>temp_array[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>), <span class="dv">1</span><span class="sc">:</span>nlat, <span class="dv">1</span><span class="sc">:</span>nt] <span class="ot">&lt;-</span>  SST_mon[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon, nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nt] </span>
<span id="cb51-10"><a href="#cb51-10" tabindex="-1"></a>temp_array[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon, <span class="dv">1</span><span class="sc">:</span>nlat, <span class="dv">1</span><span class="sc">:</span>nt] <span class="ot">&lt;-</span>  SST_mon[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>), nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nt]</span>
<span id="cb51-11"><a href="#cb51-11" tabindex="-1"></a>SST_mon <span class="ot">&lt;-</span> temp_array</span></code></pre></div>
<p>Get a levelplot to check that the data has been read correctly:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="co"># levelplot </span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">2</span></span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lon=</span>lon, <span class="at">lat=</span>lat)</span>
<span id="cb52-4"><a href="#cb52-4" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="sc">-</span><span class="dv">4</span>,<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">25</span>,<span class="dv">35</span>)</span>
<span id="cb52-5"><a href="#cb52-5" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(SST_mon[,, n] <span class="sc">~</span> lon <span class="sc">*</span> lat, <span class="at">data=</span>grid, <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb52-6"><a href="#cb52-6" tabindex="-1"></a>          <span class="at">col.regions=</span>(<span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">10</span>,<span class="st">&quot;RdBu&quot;</span>))))</span>
<span id="cb52-7"><a href="#cb52-7" tabindex="-1"></a>plt <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">layer</span>(<span class="fu">sp.lines</span>(coast_outline, <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">lwd=</span><span class="fl">0.5</span>))</span></code></pre></div>
<p>Inspection of the time range of the data reveals that there are few
months from 2019 in the data array. Get rid of these</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="co"># chop off last three months of the data, and also the time variables</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>SST_mon <span class="ot">&lt;-</span> SST_mon[,, <span class="dv">1</span><span class="sc">:</span>(nt<span class="dv">-3</span>)]</span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a><span class="fu">dim</span>(SST_mon)</span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a>time <span class="ot">&lt;-</span> time[<span class="dv">1</span><span class="sc">:</span>(nt<span class="dv">-3</span>)]</span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a>ptime <span class="ot">&lt;-</span> ptime[<span class="dv">1</span><span class="sc">:</span>(nt<span class="dv">-3</span>)]</span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a><span class="fu">head</span>(ptime); <span class="fu">tail</span>(ptime)</span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a>nt <span class="ot">&lt;-</span> nt <span class="sc">-</span> <span class="dv">3</span></span></code></pre></div>
<p>Now get the long-term means (which have the same longitudes and
latitudes as the monthly values, so no need to get those).:</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="co"># get SSTs ltms</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>SST_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>SST_ltm_name <span class="ot">&lt;-</span> <span class="st">&quot;NOAA_ERSSTv5_sst.mon.ltm.1981-2010.nc&quot;</span></span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a>SST_ltm_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(SST_path, SST_ltm_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a>dname_ltm <span class="ot">&lt;-</span> <span class="st">&quot;sst&quot;</span></span>
<span id="cb54-6"><a href="#cb54-6" tabindex="-1"></a></span>
<span id="cb54-7"><a href="#cb54-7" tabindex="-1"></a><span class="co"># open a netCDF file</span></span>
<span id="cb54-8"><a href="#cb54-8" tabindex="-1"></a>ncin <span class="ot">&lt;-</span> <span class="fu">nc_open</span>(SST_ltm_file)</span>
<span id="cb54-9"><a href="#cb54-9" tabindex="-1"></a><span class="co">#print(ncin)</span></span>
<span id="cb54-10"><a href="#cb54-10" tabindex="-1"></a></span>
<span id="cb54-11"><a href="#cb54-11" tabindex="-1"></a><span class="co"># get time</span></span>
<span id="cb54-12"><a href="#cb54-12" tabindex="-1"></a>time <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;time&quot;</span>)</span>
<span id="cb54-13"><a href="#cb54-13" tabindex="-1"></a>tunits <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="st">&quot;time&quot;</span>,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb54-14"><a href="#cb54-14" tabindex="-1"></a>nm <span class="ot">&lt;-</span> <span class="fu">dim</span>(time)</span>
<span id="cb54-15"><a href="#cb54-15" tabindex="-1"></a>nm; tunits</span>
<span id="cb54-16"><a href="#cb54-16" tabindex="-1"></a></span>
<span id="cb54-17"><a href="#cb54-17" tabindex="-1"></a>SST_ltm <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,dname_ltm)</span>
<span id="cb54-18"><a href="#cb54-18" tabindex="-1"></a>dlname_ltm <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname_ltm,<span class="st">&quot;long_name&quot;</span>)</span>
<span id="cb54-19"><a href="#cb54-19" tabindex="-1"></a>dunits_ltm <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname_ltm,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb54-20"><a href="#cb54-20" tabindex="-1"></a>fillvalue_ltm <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname_ltm,<span class="st">&quot;_FillValue&quot;</span>)</span>
<span id="cb54-21"><a href="#cb54-21" tabindex="-1"></a><span class="fu">dim</span>(SST_ltm)</span>
<span id="cb54-22"><a href="#cb54-22" tabindex="-1"></a></span>
<span id="cb54-23"><a href="#cb54-23" tabindex="-1"></a><span class="co"># close the monthly data file</span></span>
<span id="cb54-24"><a href="#cb54-24" tabindex="-1"></a><span class="fu">nc_close</span>(ncin)</span></code></pre></div>
<p>Flip the data (but not the latitudes; they are already in the right
order):</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="co"># flip N-S</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>temp_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(nlon, nlat, nm))</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>temp_array[<span class="dv">1</span><span class="sc">:</span>nlon, <span class="dv">1</span><span class="sc">:</span>nlat, <span class="dv">1</span><span class="sc">:</span>nm] <span class="ot">&lt;-</span>  SST_ltm[<span class="dv">1</span><span class="sc">:</span>nlon, nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nm] </span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a>SST_ltm <span class="ot">&lt;-</span> temp_array</span></code></pre></div>
<p>Again, the data could also be rotated, but that’s not done here:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a><span class="co"># rotate 0 to 360 to -180 to +180</span></span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>temp_lon <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, nlon)</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a>temp_lon[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>)] <span class="ot">&lt;-</span>  lon[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon] <span class="sc">-</span> <span class="fl">360.0</span></span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>temp_lon[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon] <span class="ot">&lt;-</span>  lon[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>)]</span>
<span id="cb56-5"><a href="#cb56-5" tabindex="-1"></a>temp_lon</span>
<span id="cb56-6"><a href="#cb56-6" tabindex="-1"></a>lon <span class="ot">&lt;-</span> temp_lon</span>
<span id="cb56-7"><a href="#cb56-7" tabindex="-1"></a></span>
<span id="cb56-8"><a href="#cb56-8" tabindex="-1"></a>temp_array <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim =</span> <span class="fu">c</span>(nlon, nlat, nt))</span>
<span id="cb56-9"><a href="#cb56-9" tabindex="-1"></a>temp_array[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>), <span class="dv">1</span><span class="sc">:</span>nlat, <span class="dv">1</span><span class="sc">:</span>nt] <span class="ot">&lt;-</span>  SST_ltm[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon, nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nt]</span>
<span id="cb56-10"><a href="#cb56-10" tabindex="-1"></a>temp_array[((nlon<span class="sc">/</span><span class="dv">2</span>)<span class="sc">+</span><span class="dv">1</span>)<span class="sc">:</span>nlon, <span class="dv">1</span><span class="sc">:</span>nlat, <span class="dv">1</span><span class="sc">:</span>nt] <span class="ot">&lt;-</span>  SST_ltm[<span class="dv">1</span><span class="sc">:</span>(nlon<span class="sc">/</span><span class="dv">2</span>), nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nt]</span>
<span id="cb56-11"><a href="#cb56-11" tabindex="-1"></a>SST_ltm <span class="ot">&lt;-</span> temp_array</span></code></pre></div>
<p>Map the data to check that it’s been read in ok:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="co"># levelplot </span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> <span class="dv">8</span></span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lon=</span>lon, <span class="at">lat=</span>lat)</span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">5</span>,<span class="sc">-</span><span class="dv">4</span>,<span class="sc">-</span><span class="dv">3</span>,<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="dv">0</span>,<span class="dv">5</span>,<span class="dv">10</span>,<span class="dv">15</span>,<span class="dv">25</span>,<span class="dv">35</span>)</span>
<span id="cb57-5"><a href="#cb57-5" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(SST_ltm[,, n] <span class="sc">~</span> lon <span class="sc">*</span> lat, <span class="at">data=</span>grid, <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb57-6"><a href="#cb57-6" tabindex="-1"></a>                 <span class="at">col.regions=</span>(<span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">10</span>,<span class="st">&quot;RdBu&quot;</span>))))</span>
<span id="cb57-7"><a href="#cb57-7" tabindex="-1"></a>plt <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">layer</span>(<span class="fu">sp.lines</span>(coast_outline, <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">lwd=</span><span class="fl">0.5</span>))</span></code></pre></div>
<p>Get the beginning and ending years</p>
<div class="sourceCode" id="cb58"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb58-1"><a href="#cb58-1" tabindex="-1"></a><span class="co"># get beginning year and ending year</span></span>
<span id="cb58-2"><a href="#cb58-2" tabindex="-1"></a>beg_date <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">as.character</span>(ptime[<span class="dv">1</span>]), <span class="st">&quot; &quot;</span>)</span>
<span id="cb58-3"><a href="#cb58-3" tabindex="-1"></a>beg_yr <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">as.character</span>(beg_date), <span class="st">&quot;-&quot;</span>))[<span class="dv">1</span>])</span>
<span id="cb58-4"><a href="#cb58-4" tabindex="-1"></a>end_date <span class="ot">&lt;-</span> <span class="fu">strsplit</span>(<span class="fu">as.character</span>(ptime[nt]), <span class="st">&quot; &quot;</span>)</span>
<span id="cb58-5"><a href="#cb58-5" tabindex="-1"></a>end_yr <span class="ot">&lt;-</span> <span class="fu">as.numeric</span>(<span class="fu">unlist</span>(<span class="fu">strsplit</span>(<span class="fu">as.character</span>(end_date), <span class="st">&quot;-&quot;</span>))[<span class="dv">1</span>])</span>
<span id="cb58-6"><a href="#cb58-6" tabindex="-1"></a>nyrs <span class="ot">&lt;-</span> end_yr <span class="sc">-</span> beg_yr <span class="sc">+</span> <span class="dv">1</span></span>
<span id="cb58-7"><a href="#cb58-7" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(beg_yr, end_yr, nyrs, nm))</span></code></pre></div>
<p>Now get the anomalies:</p>
<div class="sourceCode" id="cb59"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb59-1"><a href="#cb59-1" tabindex="-1"></a><span class="co"># get anomalies</span></span>
<span id="cb59-2"><a href="#cb59-2" tabindex="-1"></a>SST_anm <span class="ot">&lt;-</span> SST_mon <span class="sc">-</span> <span class="fu">rep</span>(SST_ltm, nyrs)</span></code></pre></div>
<p>Map the data to check the anomalies:</p>
<div class="sourceCode" id="cb60"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb60-1"><a href="#cb60-1" tabindex="-1"></a><span class="co"># levelplot </span></span>
<span id="cb60-2"><a href="#cb60-2" tabindex="-1"></a>n <span class="ot">&lt;-</span> nt</span>
<span id="cb60-3"><a href="#cb60-3" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lon=</span>lon, <span class="at">lat=</span>lat)</span>
<span id="cb60-4"><a href="#cb60-4" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">2</span>,<span class="sc">-</span><span class="dv">1</span>,<span class="sc">-</span>.<span class="dv">5</span>,<span class="sc">-</span>.<span class="dv">2</span>,<span class="sc">-</span>.<span class="dv">1</span>,<span class="dv">0</span>,.<span class="dv">1</span>,.<span class="dv">2</span>,.<span class="dv">5</span>,<span class="dv">1</span>,<span class="dv">2</span>)</span>
<span id="cb60-5"><a href="#cb60-5" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(SST_anm[,, n] <span class="sc">~</span> lon <span class="sc">*</span> lat, <span class="at">data=</span>grid, <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb60-6"><a href="#cb60-6" tabindex="-1"></a>                 <span class="at">col.regions=</span>(<span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">10</span>,<span class="st">&quot;RdBu&quot;</span>))))</span>
<span id="cb60-7"><a href="#cb60-7" tabindex="-1"></a>plt <span class="sc">+</span> latticeExtra<span class="sc">::</span><span class="fu">layer</span>(<span class="fu">sp.lines</span>(coast_outline, <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">lwd=</span><span class="fl">0.5</span>))</span></code></pre></div>
</div>
<div id="hovmöller" class="section level2" number="4.2">
<h2><span class="header-section-number">4.2</span> Hovmöller</h2>
<p>The first Hovmöller plot attempts to reproduce the NOAA ESRL PSD
Hovmöller plot of tropical Pacific temperatures between 3.5 S and 3.5 N
along a transect from the Indian ocean to the eastern Pacific <a
href="https://www.esrl.noaa.gov/psd/map/images/sst/sst.month.anom.hov.io.gif">[View
Plot]</a>. Set up for selecting those data by getting the longitude
<code>j</code> and latitude <code>k</code> indices of the bounding
box:</p>
<div class="sourceCode" id="cb61"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb61-1"><a href="#cb61-1" tabindex="-1"></a><span class="co"># get tropical Pacific</span></span>
<span id="cb61-2"><a href="#cb61-2" tabindex="-1"></a>tlon_min <span class="ot">&lt;-</span> <span class="dv">40</span>; tlon_max <span class="ot">&lt;-</span> <span class="dv">280</span>; tlat_min <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">4</span>; tlat_max <span class="ot">&lt;-</span> <span class="dv">4</span></span>
<span id="cb61-3"><a href="#cb61-3" tabindex="-1"></a>jmin <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlon_min <span class="sc">-</span> lon))</span>
<span id="cb61-4"><a href="#cb61-4" tabindex="-1"></a>jmax <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlon_max <span class="sc">-</span> lon))</span>
<span id="cb61-5"><a href="#cb61-5" tabindex="-1"></a>kmin <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlat_min <span class="sc">-</span> lat))</span>
<span id="cb61-6"><a href="#cb61-6" tabindex="-1"></a>kmax <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlat_max <span class="sc">-</span> lat))</span>
<span id="cb61-7"><a href="#cb61-7" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(jmin, lon[jmin], jmax, lon[jmax], kmin, lat[kmin], kmax, lat[kmax]))</span></code></pre></div>
<p>Now create a raster brick from the 3-D array of anomalies, selecting
data from the Pacific region just defined. Also just get data from 1989
onwards:</p>
<div class="sourceCode" id="cb62"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb62-1"><a href="#cb62-1" tabindex="-1"></a><span class="co"># tropical pacific</span></span>
<span id="cb62-2"><a href="#cb62-2" tabindex="-1"></a>SST_raster <span class="ot">&lt;-</span> <span class="fu">brick</span>(SST_anm[jmin<span class="sc">:</span>jmax, kmax<span class="sc">:</span>kmin, <span class="dv">1621</span><span class="sc">:</span>nt], </span>
<span id="cb62-3"><a href="#cb62-3" tabindex="-1"></a>                    <span class="at">xmn=</span>lon[jmin], <span class="at">xmx=</span>lon[jmax], <span class="at">ymn=</span>lat[kmin], <span class="at">ymx=</span>lat[kmax],</span>
<span id="cb62-4"><a href="#cb62-4" tabindex="-1"></a>                    <span class="at">transpose=</span><span class="cn">TRUE</span>,</span>
<span id="cb62-5"><a href="#cb62-5" tabindex="-1"></a>                    <span class="at">crs=</span><span class="st">&quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</span>)</span>
<span id="cb62-6"><a href="#cb62-6" tabindex="-1"></a>SST_raster</span></code></pre></div>
<p>Replace the layer names with appropriate date labels:</p>
<div class="sourceCode" id="cb63"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb63-1"><a href="#cb63-1" tabindex="-1"></a><span class="co"># replace layer names</span></span>
<span id="cb63-2"><a href="#cb63-2" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(ptime[<span class="dv">1621</span>]), <span class="fu">as.Date</span>(ptime[nt]), <span class="at">by=</span><span class="st">&#39;month&#39;</span>)</span>
<span id="cb63-3"><a href="#cb63-3" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">as.yearmon</span>(idx)</span>
<span id="cb63-4"><a href="#cb63-4" tabindex="-1"></a>SST_raster <span class="ot">&lt;-</span> <span class="fu">setZ</span>(SST_raster, idx, <span class="at">name=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb63-5"><a href="#cb63-5" tabindex="-1"></a><span class="fu">names</span>(SST_raster) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(idx)</span>
<span id="cb63-6"><a href="#cb63-6" tabindex="-1"></a>SST_raster</span></code></pre></div>
<p>Here’s the Hovmöller plot:</p>
<div class="sourceCode" id="cb64"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb64-1"><a href="#cb64-1" tabindex="-1"></a><span class="fu">hovmoller</span>(SST_raster,</span>
<span id="cb64-2"><a href="#cb64-2" tabindex="-1"></a>      <span class="at">dirXY =</span> x,</span>
<span id="cb64-3"><a href="#cb64-3" tabindex="-1"></a>      <span class="at">at =</span> <span class="fu">do.breaks</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">4</span>),<span class="dv">16</span>),</span>
<span id="cb64-4"><a href="#cb64-4" tabindex="-1"></a>      <span class="at">contour=</span><span class="cn">FALSE</span>, <span class="at">interpolate=</span><span class="cn">FALSE</span>,</span>
<span id="cb64-5"><a href="#cb64-5" tabindex="-1"></a>      <span class="at">par.settings=</span><span class="fu">RdBuTheme</span>(<span class="at">region=</span><span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&#39;RdBu&#39;</span>))),</span>
<span id="cb64-6"><a href="#cb64-6" tabindex="-1"></a>      <span class="at">main=</span><span class="st">&quot;Tropical Pacific SST Anomalies&quot;</span> )</span></code></pre></div>
<p>Note that data for the globe could have been selected as follows</p>
<div class="sourceCode" id="cb65"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb65-1"><a href="#cb65-1" tabindex="-1"></a><span class="co"># globe</span></span>
<span id="cb65-2"><a href="#cb65-2" tabindex="-1"></a>SST_raster <span class="ot">&lt;-</span> <span class="fu">brick</span>(SST_anm[<span class="dv">1</span><span class="sc">:</span>nlon, nlat<span class="sc">:</span><span class="dv">1</span>, <span class="dv">1</span><span class="sc">:</span>nt],</span>
<span id="cb65-3"><a href="#cb65-3" tabindex="-1"></a>                    <span class="at">xmn=</span>lon[<span class="dv">1</span>], <span class="at">xmx=</span>lon[nlon], <span class="at">ymn=</span>lat[<span class="dv">1</span>], <span class="at">ymx=</span>lat[nlat],</span>
<span id="cb65-4"><a href="#cb65-4" tabindex="-1"></a>                    <span class="at">transpose=</span><span class="cn">FALSE</span>,</span>
<span id="cb65-5"><a href="#cb65-5" tabindex="-1"></a>                    <span class="at">crs=</span><span class="st">&quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</span>)</span>
<span id="cb65-6"><a href="#cb65-6" tabindex="-1"></a>SST_raster</span>
<span id="cb65-7"><a href="#cb65-7" tabindex="-1"></a></span>
<span id="cb65-8"><a href="#cb65-8" tabindex="-1"></a><span class="co"># replace layer names</span></span>
<span id="cb65-9"><a href="#cb65-9" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(ptime[<span class="dv">1</span>]), <span class="fu">as.Date</span>(ptime[nt]), <span class="at">by=</span><span class="st">&#39;month&#39;</span>)</span>
<span id="cb65-10"><a href="#cb65-10" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">as.yearmon</span>(idx)</span>
<span id="cb65-11"><a href="#cb65-11" tabindex="-1"></a>SST_raster <span class="ot">&lt;-</span> <span class="fu">setZ</span>(SST_raster, idx, <span class="at">name=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb65-12"><a href="#cb65-12" tabindex="-1"></a><span class="fu">names</span>(SST_raster) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(idx)</span>
<span id="cb65-13"><a href="#cb65-13" tabindex="-1"></a>SST_raster</span></code></pre></div>
</div>
<div id="horizon-plot" class="section level2" number="4.3">
<h2><span class="header-section-number">4.3</span> Horizon plot</h2>
<p>The horizon plot plots multiple time series (here average values for
individual latitudinal zones) in a way that allows common trends to be
visualized. For this example, select a more latitudinally extensive
chunk of data:</p>
<div class="sourceCode" id="cb66"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb66-1"><a href="#cb66-1" tabindex="-1"></a><span class="co"># horizon plot</span></span>
<span id="cb66-2"><a href="#cb66-2" tabindex="-1"></a><span class="co"># get tropical Pacific</span></span>
<span id="cb66-3"><a href="#cb66-3" tabindex="-1"></a>tlon_min <span class="ot">&lt;-</span> <span class="dv">178</span>; tlon_max <span class="ot">&lt;-</span> <span class="dv">290</span>; tlat_min <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">30</span>; tlat_max <span class="ot">&lt;-</span> <span class="dv">30</span></span>
<span id="cb66-4"><a href="#cb66-4" tabindex="-1"></a>jmin <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlon_min <span class="sc">-</span> lon))</span>
<span id="cb66-5"><a href="#cb66-5" tabindex="-1"></a>jmax <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlon_max <span class="sc">-</span> lon))</span>
<span id="cb66-6"><a href="#cb66-6" tabindex="-1"></a>kmin <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlat_min <span class="sc">-</span> lat))</span>
<span id="cb66-7"><a href="#cb66-7" tabindex="-1"></a>kmax <span class="ot">&lt;-</span> <span class="fu">which.min</span>(<span class="fu">abs</span>(tlat_max <span class="sc">-</span> lat))</span>
<span id="cb66-8"><a href="#cb66-8" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(jmin, lon[jmin], jmax, lon[jmax], kmin, lat[kmin], kmax, lat[kmax]))</span></code></pre></div>
<div class="sourceCode" id="cb67"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb67-1"><a href="#cb67-1" tabindex="-1"></a><span class="co"># tropical pacific</span></span>
<span id="cb67-2"><a href="#cb67-2" tabindex="-1"></a>SST_raster <span class="ot">&lt;-</span> <span class="fu">brick</span>(SST_anm[jmin<span class="sc">:</span>jmax, kmax<span class="sc">:</span>kmin, <span class="dv">1621</span><span class="sc">:</span>nt], </span>
<span id="cb67-3"><a href="#cb67-3" tabindex="-1"></a>                    <span class="at">xmn=</span>lon[jmin], <span class="at">xmx=</span>lon[jmax], <span class="at">ymn=</span>lat[kmin], <span class="at">ymx=</span>lat[kmax],</span>
<span id="cb67-4"><a href="#cb67-4" tabindex="-1"></a>                    <span class="at">transpose=</span><span class="cn">TRUE</span>,</span>
<span id="cb67-5"><a href="#cb67-5" tabindex="-1"></a>                    <span class="at">crs=</span><span class="st">&quot;+proj=longlat +datum=WGS84 +ellps=WGS84 +towgs84=0,0,0&quot;</span>)</span>
<span id="cb67-6"><a href="#cb67-6" tabindex="-1"></a>SST_raster</span></code></pre></div>
<div class="sourceCode" id="cb68"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb68-1"><a href="#cb68-1" tabindex="-1"></a><span class="co"># replace layer names</span></span>
<span id="cb68-2"><a href="#cb68-2" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(ptime[<span class="dv">1621</span>]), <span class="fu">as.Date</span>(ptime[nt]), <span class="at">by=</span><span class="st">&#39;month&#39;</span>)</span>
<span id="cb68-3"><a href="#cb68-3" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">as.yearmon</span>(idx)</span>
<span id="cb68-4"><a href="#cb68-4" tabindex="-1"></a>SST_raster <span class="ot">&lt;-</span> <span class="fu">setZ</span>(SST_raster, idx, <span class="at">name=</span><span class="st">&quot;time&quot;</span>)</span>
<span id="cb68-5"><a href="#cb68-5" tabindex="-1"></a><span class="fu">names</span>(SST_raster) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(idx)</span>
<span id="cb68-6"><a href="#cb68-6" tabindex="-1"></a>SST_raster</span></code></pre></div>
<p>Here’s the horizon plot:</p>
<div class="sourceCode" id="cb69"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb69-1"><a href="#cb69-1" tabindex="-1"></a><span class="co"># horizonplot -- rasterVis example</span></span>
<span id="cb69-2"><a href="#cb69-2" tabindex="-1"></a><span class="fu">horizonplot</span>(SST_raster, <span class="at">ylab=</span><span class="st">&quot;Latitude&quot;</span>, <span class="at">xlab=</span><span class="st">&quot;Year&quot;</span>,<span class="at">col.regions=</span><span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="at">n=</span><span class="dv">8</span>, <span class="st">&#39;RdBu&#39;</span>)) )</span></code></pre></div>
</div>
<div id="hovmöller-plots-a-second-example" class="section level2"
number="4.4">
<h2><span class="header-section-number">4.4</span> Hovmöller plots – a
second example</h2>
<p>This second example shows how a Hovmöller plot can be written
directly to a .png file, which may be useful when it takes a while to
generate. The data here are a combined set of land and ocean temperature
anomalies from 1850 through the beginning of 2019.</p>
<p>Use the <code>brick()</code> function in <code>raster</code> to read
the data.</p>
<div class="sourceCode" id="cb70"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb70-1"><a href="#cb70-1" tabindex="-1"></a><span class="co"># HADCRUT4 Combined Air Temperature/SST Anomalies</span></span>
<span id="cb70-2"><a href="#cb70-2" tabindex="-1"></a><span class="co"># read a 3-D netCDF dataset</span></span>
<span id="cb70-3"><a href="#cb70-3" tabindex="-1"></a>hadcrut_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb70-4"><a href="#cb70-4" tabindex="-1"></a>hadcrut_name <span class="ot">&lt;-</span> <span class="st">&quot;HadCRUT.4.6.0.0.median.nc&quot;</span></span>
<span id="cb70-5"><a href="#cb70-5" tabindex="-1"></a>hadcrut_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(hadcrut_path, hadcrut_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb70-6"><a href="#cb70-6" tabindex="-1"></a>hadcrut <span class="ot">&lt;-</span> <span class="fu">brick</span>(hadcrut_file) <span class="co"># open air.mon.anom.nc</span></span>
<span id="cb70-7"><a href="#cb70-7" tabindex="-1"></a></span>
<span id="cb70-8"><a href="#cb70-8" tabindex="-1"></a>hadcrut</span>
<span id="cb70-9"><a href="#cb70-9" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">filename</span>(hadcrut), <span class="fu">hasValues</span>(hadcrut), <span class="fu">inMemory</span>(hadcrut)))</span></code></pre></div>
<p>As before, replace the layer names (dates) with something more
appropriate:</p>
<div class="sourceCode" id="cb71"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb71-1"><a href="#cb71-1" tabindex="-1"></a><span class="co"># replace layer names</span></span>
<span id="cb71-2"><a href="#cb71-2" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="fu">as.Date</span>(<span class="st">&#39;1850-01-01&#39;</span>), <span class="fu">as.Date</span>(<span class="st">&#39;2019-02-01&#39;</span>), <span class="st">&#39;month&#39;</span>)</span>
<span id="cb71-3"><a href="#cb71-3" tabindex="-1"></a>idx <span class="ot">&lt;-</span> <span class="fu">as.yearmon</span>(idx)</span>
<span id="cb71-4"><a href="#cb71-4" tabindex="-1"></a>tmpplt <span class="ot">&lt;-</span> <span class="fu">setZ</span>(hadcrut, idx)</span>
<span id="cb71-5"><a href="#cb71-5" tabindex="-1"></a><span class="fu">names</span>(tmpplt) <span class="ot">&lt;-</span> <span class="fu">as.character</span>(idx)</span></code></pre></div>
<p>Produce the plot, and send it to a <code>.png</code> file:</p>
<div class="sourceCode" id="cb72"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb72-1"><a href="#cb72-1" tabindex="-1"></a><span class="co"># plot</span></span>
<span id="cb72-2"><a href="#cb72-2" tabindex="-1"></a>pngfile <span class="ot">&lt;-</span> <span class="st">&quot;HadCRUTv4_hov.png&quot;</span></span>
<span id="cb72-3"><a href="#cb72-3" tabindex="-1"></a><span class="fu">png</span>(pngfile, <span class="at">width=</span><span class="dv">720</span>, <span class="at">height=</span><span class="dv">720</span>) <span class="co"># open the file</span></span>
<span id="cb72-4"><a href="#cb72-4" tabindex="-1"></a><span class="fu">hovmoller</span>(tmpplt, <span class="at">dirXY=</span>y,</span>
<span id="cb72-5"><a href="#cb72-5" tabindex="-1"></a>      <span class="at">at =</span> <span class="fu">do.breaks</span>(<span class="fu">c</span>(<span class="sc">-</span><span class="dv">4</span>,<span class="dv">4</span>),<span class="dv">16</span>),</span>
<span id="cb72-6"><a href="#cb72-6" tabindex="-1"></a>      <span class="at">contour=</span><span class="cn">FALSE</span>, <span class="at">interpolate=</span><span class="cn">FALSE</span>,</span>
<span id="cb72-7"><a href="#cb72-7" tabindex="-1"></a>      <span class="at">par.settings=</span><span class="fu">RdBuTheme</span>(<span class="at">region=</span><span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&#39;RdBu&#39;</span>))),</span>
<span id="cb72-8"><a href="#cb72-8" tabindex="-1"></a>      <span class="at">main=</span><span class="st">&quot;HadCRU Anomalies, (1961-1990 base period)&quot;</span> )</span>
<span id="cb72-9"><a href="#cb72-9" tabindex="-1"></a><span class="co">#dev.off()</span></span></code></pre></div>
<p>Here’s what it looks like:</p>
<p><img src="HadCRUTv4_hov.png" /></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
