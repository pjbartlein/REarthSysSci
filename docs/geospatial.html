<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Geospatial analysis in R</title>

<script src="site_libs/header-attrs-2.25/header-attrs.js"></script>
<script src="site_libs/jquery-3.6.0/jquery-3.6.0.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cosmo.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<style>h1 {font-size: 34px;}
       h1.title {font-size: 38px;}
       h2 {font-size: 30px;}
       h3 {font-size: 24px;}
       h4 {font-size: 18px;}
       h5 {font-size: 16px;}
       h6 {font-size: 12px;}
       code {color: inherit; background-color: rgba(0, 0, 0, 0.04);}
       pre:not([class]) { background-color: white }</style>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<script src="site_libs/clipboard-1.7.1/clipboard.min.js"></script>
<link href="site_libs/primer-tooltips-1.4.0/build.css" rel="stylesheet" />
<link href="site_libs/klippy-0.0.0.9500/css/klippy.min.css" rel="stylesheet" />
<script src="site_libs/klippy-0.0.0.9500/js/klippy.min.js"></script>

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>



<style type="text/css">
  code {
    white-space: pre;
  }
  .sourceCode {
    overflow: visible;
  }
</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {   }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ff0000; } /* Alert */
code span.an { color: #008000; } /* Annotation */
code span.at { } /* Attribute */
code span.bu { } /* BuiltIn */
code span.cf { color: #0000ff; } /* ControlFlow */
code span.ch { color: #008080; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #008000; } /* Comment */
code span.cv { color: #008000; } /* CommentVar */
code span.do { color: #008000; } /* Documentation */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.im { } /* Import */
code span.in { color: #008000; } /* Information */
code span.kw { color: #0000ff; } /* Keyword */
code span.op { } /* Operator */
code span.ot { color: #ff4000; } /* Other */
code span.pp { color: #ff4000; } /* Preprocessor */
code span.sc { color: #008080; } /* SpecialChar */
code span.ss { color: #008080; } /* SpecialString */
code span.st { color: #008080; } /* String */
code span.va { } /* Variable */
code span.vs { color: #008080; } /* VerbatimString */
code span.wa { color: #008000; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    var j = 0;
    while (j < rules.length) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") {
        j++;
        continue;
      }
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') {
        j++;
        continue;
      }
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>




<link rel="stylesheet" href="html-md-01.css" type="text/css" />



<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
details > summary > p:only-child {
  display: inline;
}
pre code {
  padding: 0;
}
</style>


<style type="text/css">
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #adb5bd;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script type="text/javascript">
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark the anchor link active (and if it's in a dropdown, also mark that active)
  var dropdown = menuAnchor.closest('li.dropdown');
  if (window.bootstrap) { // Bootstrap 4+
    menuAnchor.addClass('active');
    dropdown.find('> .dropdown-toggle').addClass('active');
  } else { // Bootstrap 3
    menuAnchor.parent().addClass('active');
    dropdown.addClass('active');
  }

  // Navbar adjustments
  var navHeight = $(".navbar").first().height() + 15;
  var style = document.createElement('style');
  var pt = "padding-top: " + navHeight + "px; ";
  var mt = "margin-top: -" + navHeight + "px; ";
  var css = "";
  // offset scroll position for anchor links (for fixed navbar)
  for (var i = 1; i <= 6; i++) {
    css += ".section h" + i + "{ " + pt + mt + "}\n";
  }
  style.innerHTML = "body {" + pt + "padding-bottom: 40px; }\n" + css;
  document.head.appendChild(style);
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before, .tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "\e259";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "\e258";
  font-family: 'Glyphicons Halflings';
  border: none;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">




<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-bs-toggle="collapse" data-target="#navbar" data-bs-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">R for Earth-System Science</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li>
  <a href="overview.html">Overview</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Topics
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li class="dropdown-header">Lecture topics</li>
    <li>
      <a href="intro.html">Introduction: R, RStudio, and other infrastructure</a>
    </li>
    <li>
      <a href="usingR.html">Using R</a>
    </li>
    <li>
      <a href="ESSdata.html">Earth-system science data</a>
    </li>
    <li>
      <a href="netCDF.html">netCDF in R</a>
    </li>
    <li>
      <a href="raster_intro.html">raster and netCDF in R</a>
    </li>
    <li>
      <a href="hdf5_intro.html">HDF in R</a>
    </li>
    <li>
      <a href="geospatial.html">Geospatial analyses</a>
    </li>
    <li>
      <a href="RMaps.html">Maps in R</a>
    </li>
    <li>
      <a href="RMaps2.html">Maps in R (2)</a>
    </li>
    <li>
      <a href="rasterVis01.html">Visualization:  raster and rasterVis</a>
    </li>
    <li>
      <a href="vis_ggplot01.html">Visualization for explanation</a>
    </li>
    <li>
      <a href="highdim.html">Visualization of high-dimensional data</a>
    </li>
    <li>
      <a href="PCA.html">Principal components analysis</a>
    </li>
    <li>
      <a href="multivariate.html">Other multivariate analyses</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Tasks
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="geog495_ex01.html">Install R and RStudio</a>
    </li>
    <li>
      <a href="packages-and-data.html">Install packages and data</a>
    </li>
    <li>
      <a href="GitHub.html">Git and GitHub</a>
    </li>
    <li>
      <a href="Ex_UsingR.html">Using R exercise</a>
    </li>
    <li>
      <a href="markdown.html">Markdown and RMarkdown</a>
    </li>
    <li>
      <a href="install_netCDF.html">Install netCDF</a>
    </li>
    <li>
      <a href="install_Panoply.html">Install Panoply</a>
    </li>
    <li>
      <a href="transfer.html">File transfer</a>
    </li>
    <li>
      <a href="project.html">GitHub project repository and web page</a>
    </li>
    <li>
      <a href="ltms-and-anomalies.html">Long-term means and anomalies</a>
    </li>
  </ul>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" data-bs-toggle="dropdown" aria-expanded="false">
    Resources
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
    <li>
      <a href="readings.html">Readings</a>
    </li>
    <li>
      <a href="websites.html">Old course web pages</a>
    </li>
  </ul>
</li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li>
  <a href="about.html">About</a>
</li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div id="header">



<h1 class="title toc-ignore">Geospatial analysis in R</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#introduction" id="toc-introduction"><span
class="toc-section-number">1</span> Introduction</a>
<ul>
<li><a href="#spatial-data-and-geospatial-analyses-in-r"
id="toc-spatial-data-and-geospatial-analyses-in-r"><span
class="toc-section-number">1.1</span> Spatial data and geospatial
analyses in R</a></li>
<li><a href="#spatial-classes" id="toc-spatial-classes"><span
class="toc-section-number">1.2</span> Spatial classes</a></li>
</ul></li>
<li><a href="#basic-mapping" id="toc-basic-mapping"><span
class="toc-section-number">2</span> Basic mapping</a>
<ul>
<li><a href="#load-libraries-and-read-the-shape-files"
id="toc-load-libraries-and-read-the-shape-files"><span
class="toc-section-number">2.1</span> Load libraries and read the shape
files</a></li>
<li><a href="#plot-both-shapefiles" id="toc-plot-both-shapefiles"><span
class="toc-section-number">2.2</span> Plot both shapefiles</a></li>
</ul></li>
<li><a href="#extract-data-from-a-raster"
id="toc-extract-data-from-a-raster"><span
class="toc-section-number">3</span> Extract data from a raster</a>
<ul>
<li><a href="#read-the-data-sets-source-and-target"
id="toc-read-the-data-sets-source-and-target"><span
class="toc-section-number">3.1</span> Read the data sets – source and
target</a></li>
<li><a href="#extract-data-at-target-points"
id="toc-extract-data-at-target-points"><span
class="toc-section-number">3.2</span> Extract data at target
points</a></li>
<li><a href="#a-second-example-explicit-cell-selection"
id="toc-a-second-example-explicit-cell-selection"><span
class="toc-section-number">3.3</span> A second example – explicit cell
selection</a></li>
</ul></li>
<li><a href="#clippingtrimmingpoint-in-polygon-analyses"
id="toc-clippingtrimmingpoint-in-polygon-analyses"><span
class="toc-section-number">4</span> Clipping/Trimming/Point-in-polygon
analyses</a>
<ul>
<li><a href="#read-the-polygon-and-target-point-files"
id="toc-read-the-polygon-and-target-point-files"><span
class="toc-section-number">4.1</span> Read the polygon and target-point
files</a></li>
<li><a href="#overlay-the-points-onto-the-polygons"
id="toc-overlay-the-points-onto-the-polygons"><span
class="toc-section-number">4.2</span> Overlay the points onto the
polygons</a></li>
</ul></li>
<li><a href="#gridding-or-rasterizing-point-data"
id="toc-gridding-or-rasterizing-point-data"><span
class="toc-section-number">5</span> Gridding or rasterizing point
data</a>
<ul>
<li><a href="#read-the-data-sets-and-create-empty-rasters"
id="toc-read-the-data-sets-and-create-empty-rasters"><span
class="toc-section-number">5.1</span> Read the data sets, and create
empty rasters</a></li>
<li><a href="#rasterize-the-data" id="toc-rasterize-the-data"><span
class="toc-section-number">5.2</span> Rasterize the data</a></li>
<li><a href="#write-the-rasterized-data-out-as-a-netcdf-file"
id="toc-write-the-rasterized-data-out-as-a-netcdf-file"><span
class="toc-section-number">5.3</span> Write the rasterized data out as a
netCDF file</a></li>
</ul></li>
<li><a href="#interpolatingregridding"
id="toc-interpolatingregridding"><span
class="toc-section-number">6</span> Interpolating/regridding</a>
<ul>
<li><a href="#open-the-control-netcdf-and-target-.csv-files"
id="toc-open-the-control-netcdf-and-target-.csv-files"><span
class="toc-section-number">6.1</span> Open the “control” netCDF and
target .csv files</a></li>
<li><a href="#interpolation" id="toc-interpolation"><span
class="toc-section-number">6.2</span> Interpolation</a></li>
</ul></li>
</ul>
</div>

<script>
  addClassKlippyTo("pre.r, pre.markdown");
  addKlippy('right', 'top', 'auto', '1', 'Copy code', 'Copied!');
</script>
<div id="introduction" class="section level1" number="1">
<h1><span class="header-section-number">1</span> Introduction</h1>
<div id="spatial-data-and-geospatial-analyses-in-r"
class="section level2" number="1.1">
<h2><span class="header-section-number">1.1</span> Spatial data and
geospatial analyses in R</h2>
<p>CRAN Spatial taskview: <a
href="https://cran.r-project.org/web/views/Spatial.html">https://cran.r-project.org/web/views/Spatial.html</a></p>
<p>The bulk of the geospatial/GISci analysis tools are contained in the
following packages:</p>
<ul>
<li><code>maptools</code> reading and writing spatial data, particularly
shapefiles</li>
<li><code>sp</code> manipulating data in one of the Spatial Data
classes</li>
<li><code>rgdal</code> R “bindings” to GDAL (Geospatial Data Abstraction
Layer)</li>
<li><code>rgeos</code> R interface to the GEOS “geometry engine”
(overlays, etc.)</li>
</ul>
<p>The book (ASDAR2) R.S. Bivand, E. Pebesma, V. Gómez-Rubio (2013)
<em>Applied Spatial Data Analysis with R, 2nd Ed.</em>, Springer.</p>
<p>Here’s a .pdf: <a
href="http://link.springer.com/content/pdf/10.1007%2F978-1-4614-7618-4.pdf">http://link.springer.com/content/pdf/10.1007%2F978-1-4614-7618-4.pdf</a>
(must be on UO Network)</p>
<p>There is also an R package <code>maps</code> that includes a world
database, and methods for plotting with the R core graphics.</p>
</div>
<div id="spatial-classes" class="section level2" number="1.2">
<h2><span class="header-section-number">1.2</span> Spatial classes</h2>
<p>There are several related “classes” of spatial data in R, each
consisting of the specific spatial coordinate or geometry data, or the
coordinate or geometry data and an associate data frame:</p>
<ul>
<li><code>SpatialPoints</code> and
<code>SpatialPointsDataFrame</code></li>
<li><code>SpatialLines</code> and
<code>SpatialLinesDataFrame</code></li>
<li><code>SpatialPolygons</code> and
<code>SpatialPolygonDataFrame</code></li>
<li><code>SpatialPixels</code> and
<code>SpatialPixelDataFrame</code></li>
<li><code>SpatialGrid</code> and <code>SpatialGridDataFrame</code></li>
<li><code>SpatialMultiPoints</code> and
<code>SpatialMultiPointsDataFrame</code></li>
</ul>
<p>The names of the classes pretty much describe the kind of information
they contain. One way to look at the landscape of geospatial data
analysis in R is that <code>maptools</code> and <code>rgdal</code> cover
reading and writing the spatial data classes, <code>sp</code> handles
plotting, conversions and manipulations (including projections with
<code>SpTransform()</code>) and <code>rgeos</code> handles geospatial
analysis tasks.</p>
<p>Many of the functions in these packages will be exercised below, but
these examples are by now means exhaustive.</p>
</div>
</div>
<div id="basic-mapping" class="section level1" number="2">
<h1><span class="header-section-number">2</span> Basic mapping</h1>
<p>Here is a very simple example of reading and plotting a couple of
shape files, that illustrates use use of some of the
<code>maptools</code> and <code>sp</code> functions:</p>
<div id="load-libraries-and-read-the-shape-files" class="section level2"
number="2.1">
<h2><span class="header-section-number">2.1</span> Load libraries and
read the shape files</h2>
<p>Load the <code>sp</code> and <code>rgdal</code> package:</p>
<div class="sourceCode" id="cb1"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb1-1"><a href="#cb1-1" tabindex="-1"></a><span class="fu">library</span>(sp)</span>
<span id="cb1-2"><a href="#cb1-2" tabindex="-1"></a><span class="fu">library</span>(rgdal)</span></code></pre></div>
<p>When <code>maptools</code> or <code>sp</code> is loaded, they also
check for the presence of the <code>rgeos</code> package.</p>
<p>Read two shape files, one of Oreogon county outlines, the other of
climate-station locations:</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb2-1"><a href="#cb2-1" tabindex="-1"></a><span class="co"># read county outlines</span></span>
<span id="cb2-2"><a href="#cb2-2" tabindex="-1"></a>otl_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/shp_files/OR/&quot;</span></span>
<span id="cb2-3"><a href="#cb2-3" tabindex="-1"></a>otl_name <span class="ot">&lt;-</span> <span class="st">&quot;orotl.shp&quot;</span></span>
<span id="cb2-4"><a href="#cb2-4" tabindex="-1"></a>otl_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(otl_path, otl_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb2-5"><a href="#cb2-5" tabindex="-1"></a>orotl_shp <span class="ot">&lt;-</span> <span class="fu">readOGR</span>(otl_file)</span></code></pre></div>
<p>Check what kind of spatial data class this shapefile is</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb3-1"><a href="#cb3-1" tabindex="-1"></a><span class="fu">class</span>(orotl_shp)</span>
<span id="cb3-2"><a href="#cb3-2" tabindex="-1"></a><span class="fu">summary</span>(orotl_shp)</span></code></pre></div>
<p>Note that the shapefile is a <code>SpatialLinesDataFrame</code> that
in addition to the geometry of the counties (the outlines) also contains
data (the names). Plot the county outline shapefile:</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb4-1"><a href="#cb4-1" tabindex="-1"></a><span class="fu">plot</span>(orotl_shp)</span></code></pre></div>
<p>Now get the climate-station data</p>
<div class="sourceCode" id="cb5"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb5-1"><a href="#cb5-1" tabindex="-1"></a><span class="co"># read stations</span></span>
<span id="cb5-2"><a href="#cb5-2" tabindex="-1"></a>orstations_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/shp_files/OR/&quot;</span></span>
<span id="cb5-3"><a href="#cb5-3" tabindex="-1"></a>orstations_name <span class="ot">&lt;-</span> <span class="st">&quot;orstations.shp&quot;</span></span>
<span id="cb5-4"><a href="#cb5-4" tabindex="-1"></a>orstations_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(orstations_path, orstations_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb5-5"><a href="#cb5-5" tabindex="-1"></a>orstations_shp <span class="ot">&lt;-</span> <span class="fu">readOGR</span>(orstations_file)</span>
<span id="cb5-6"><a href="#cb5-6" tabindex="-1"></a></span>
<span id="cb5-7"><a href="#cb5-7" tabindex="-1"></a><span class="co"># check stations shapefile</span></span>
<span id="cb5-8"><a href="#cb5-8" tabindex="-1"></a><span class="fu">class</span>(orstations_shp)</span>
<span id="cb5-9"><a href="#cb5-9" tabindex="-1"></a><span class="fu">summary</span>(orstations_shp)</span></code></pre></div>
<p>Note that this shape file also contains some climate data for each
station, as well as the station names and locations.</p>
</div>
<div id="plot-both-shapefiles" class="section level2" number="2.2">
<h2><span class="header-section-number">2.2</span> Plot both
shapefiles</h2>
<p>Plot the station data:</p>
<div class="sourceCode" id="cb6"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb6-1"><a href="#cb6-1" tabindex="-1"></a><span class="co"># plot the station data on top of the outline map</span></span>
<span id="cb6-2"><a href="#cb6-2" tabindex="-1"></a><span class="fu">plot</span>(orotl_shp)</span>
<span id="cb6-3"><a href="#cb6-3" tabindex="-1"></a><span class="fu">points</span>(orstations_shp, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.7</span>, <span class="at">col=</span><span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p>More examples of simple maps can be found in the materials for
Lecture 5 in GEOG 4/595: <a
href="http://geog.uoregon.edu/bartlein/courses/geog495/lectures/lec05.html">http://geog.uoregon.edu/bartlein/courses/geog495/lectures/lec05.html</a></p>
<p><a href="geospatial.html">[Back to top]</a></p>
</div>
</div>
<div id="extract-data-from-a-raster" class="section level1" number="3">
<h1><span class="header-section-number">3</span> Extract data from a
raster</h1>
<p>This example demonstrates how to extract data from a raster for a set
of target points contained in a .csv file. In this case, the raster is
the Ramankutty and Foley potential natural vegetation data set (<a
href="Shttps://www.nelson.wisc.edu/sage/data-and-models/global-land-use/index.php">https://www.nelson.wisc.edu/sage/data-and-models/global-land-use/index.php</a>),
and the target points are the Global Charcoal Database (GCDv3) site
locations (<a
href="http://www.gpwg.paleofire.org">http://www.gpwg.paleofire.org</a>)</p>
<div class="sourceCode" id="cb7"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb7-1"><a href="#cb7-1" tabindex="-1"></a><span class="co"># load packages</span></span>
<span id="cb7-2"><a href="#cb7-2" tabindex="-1"></a><span class="fu">library</span>(ncdf4)</span>
<span id="cb7-3"><a href="#cb7-3" tabindex="-1"></a><span class="fu">library</span>(raster)</span>
<span id="cb7-4"><a href="#cb7-4" tabindex="-1"></a><span class="fu">library</span>(rasterVis)</span></code></pre></div>
<div id="read-the-data-sets-source-and-target" class="section level2"
number="3.1">
<h2><span class="header-section-number">3.1</span> Read the data sets –
source and target</h2>
<p>User the <code>raster</code> package to read the vegetation data</p>
<div class="sourceCode" id="cb8"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb8-1"><a href="#cb8-1" tabindex="-1"></a><span class="co"># read potential natural vegetation data sage_veg30.nc:</span></span>
<span id="cb8-2"><a href="#cb8-2" tabindex="-1"></a>vegtype_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb8-3"><a href="#cb8-3" tabindex="-1"></a>vegtype_name <span class="ot">&lt;-</span> <span class="st">&quot;sage_veg30.nc&quot;</span></span>
<span id="cb8-4"><a href="#cb8-4" tabindex="-1"></a>vegtype_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(vegtype_path, vegtype_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb8-5"><a href="#cb8-5" tabindex="-1"></a>vegtype <span class="ot">&lt;-</span> <span class="fu">raster</span>(vegtype_file, <span class="at">varname=</span><span class="st">&quot;vegtype&quot;</span>)</span>
<span id="cb8-6"><a href="#cb8-6" tabindex="-1"></a>vegtype</span></code></pre></div>
<p>Plot the vegetation data using a <code>rasterVis</code>
levelplot:</p>
<div class="sourceCode" id="cb9"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb9-1"><a href="#cb9-1" tabindex="-1"></a>mapTheme <span class="ot">&lt;-</span> <span class="fu">rasterTheme</span>(<span class="at">region=</span><span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&quot;Greens&quot;</span>)))</span>
<span id="cb9-2"><a href="#cb9-2" tabindex="-1"></a><span class="fu">levelplot</span>(vegtype, <span class="at">margin=</span>F, <span class="at">par.settings=</span>mapTheme,</span>
<span id="cb9-3"><a href="#cb9-3" tabindex="-1"></a>                 <span class="at">main=</span><span class="st">&quot;Potential Natural Vegetation&quot;</span>)</span></code></pre></div>
<p>Read the charcoal data locations:</p>
<div class="sourceCode" id="cb10"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb10-1"><a href="#cb10-1" tabindex="-1"></a><span class="co"># read GCDv3 sites</span></span>
<span id="cb10-2"><a href="#cb10-2" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/csv_files/&quot;</span></span>
<span id="cb10-3"><a href="#cb10-3" tabindex="-1"></a>csv_name <span class="ot">&lt;-</span> <span class="st">&quot;v3i_nsa_globe.csv&quot;</span></span>
<span id="cb10-4"><a href="#cb10-4" tabindex="-1"></a>csv_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(csv_path, csv_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb10-5"><a href="#cb10-5" tabindex="-1"></a>gcdv3 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(csv_file) </span>
<span id="cb10-6"><a href="#cb10-6" tabindex="-1"></a><span class="fu">str</span>(gcdv3)</span>
<span id="cb10-7"><a href="#cb10-7" tabindex="-1"></a><span class="fu">plot</span>(gcdv3<span class="sc">$</span>Lon, gcdv3<span class="sc">$</span>Lat, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.5</span>, <span class="at">col=</span><span class="st">&quot;blue&quot;</span>)</span></code></pre></div>
<p>In order to use the <code>extract()</code> function from
<code>raster</code>, the target points must be turned into a
<code>SpatialPoints</code> data set.</p>
<div class="sourceCode" id="cb11"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb11-1"><a href="#cb11-1" tabindex="-1"></a><span class="co"># turn into SpatialPoints</span></span>
<span id="cb11-2"><a href="#cb11-2" tabindex="-1"></a>gcdv3_coords <span class="ot">&lt;-</span> <span class="fu">cbind</span>(gcdv3<span class="sc">$</span>Lon, gcdv3<span class="sc">$</span>Lat)</span>
<span id="cb11-3"><a href="#cb11-3" tabindex="-1"></a>gcdv3_pts <span class="ot">&lt;-</span> <span class="fu">SpatialPoints</span>(<span class="at">coords=</span>gcdv3_coords, <span class="at">proj4string =</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span>
<span id="cb11-4"><a href="#cb11-4" tabindex="-1"></a><span class="fu">class</span>(gcdv3_pts)</span>
<span id="cb11-5"><a href="#cb11-5" tabindex="-1"></a><span class="co"># plot(gcdv3_pts, pch=16, cex=0.5)</span></span></code></pre></div>
<p>Plot the target points on top of ths source map:</p>
<div class="sourceCode" id="cb12"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb12-1"><a href="#cb12-1" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(vegtype, <span class="at">margin=</span>F, <span class="at">par.settings=</span>mapTheme,</span>
<span id="cb12-2"><a href="#cb12-2" tabindex="-1"></a>                 <span class="at">main=</span><span class="st">&quot;Potential Natural Vegetation&quot;</span>)</span>
<span id="cb12-3"><a href="#cb12-3" tabindex="-1"></a>plt <span class="sc">+</span> <span class="fu">layer</span>(<span class="fu">sp.points</span>(gcdv3_pts, <span class="at">col=</span><span class="st">&quot;blue&quot;</span>, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.5</span>))</span></code></pre></div>
</div>
<div id="extract-data-at-target-points" class="section level2"
number="3.2">
<h2><span class="header-section-number">3.2</span> Extract data at
target points</h2>
<p>Now extract the data for the target points:</p>
<div class="sourceCode" id="cb13"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb13-1"><a href="#cb13-1" tabindex="-1"></a><span class="co"># extract data from the raster at the target points</span></span>
<span id="cb13-2"><a href="#cb13-2" tabindex="-1"></a>gcdv3_vegtype <span class="ot">&lt;-</span> <span class="fu">extract</span>(vegtype, gcdv3_pts, <span class="at">method=</span><span class="st">&quot;simple&quot;</span>)</span>
<span id="cb13-3"><a href="#cb13-3" tabindex="-1"></a><span class="fu">class</span>(gcdv3_vegtype)</span>
<span id="cb13-4"><a href="#cb13-4" tabindex="-1"></a><span class="fu">head</span>(gcdv3_vegtype)</span></code></pre></div>
<p>Make a dataframe of the extracted data that could be saved as a .csv
file, and plot it:</p>
<div class="sourceCode" id="cb14"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb14-1"><a href="#cb14-1" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(gcdv3<span class="sc">$</span>Lon, gcdv3<span class="sc">$</span>Lat, gcdv3_vegtype)</span>
<span id="cb14-2"><a href="#cb14-2" tabindex="-1"></a><span class="fu">names</span>(pts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Lon&quot;</span>, <span class="st">&quot;Lat&quot;</span>, <span class="st">&quot;vegtype&quot;</span>)</span>
<span id="cb14-3"><a href="#cb14-3" tabindex="-1"></a><span class="fu">head</span>(pts, <span class="dv">10</span>)</span>
<span id="cb14-4"><a href="#cb14-4" tabindex="-1"></a>plotclr <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&quot;Greens&quot;</span>))</span>
<span id="cb14-5"><a href="#cb14-5" tabindex="-1"></a>plotclr <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;#AAAAAA&quot;</span>, plotclr)</span>
<span id="cb14-6"><a href="#cb14-6" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">14</span>, <span class="dv">16</span>)</span>
<span id="cb14-7"><a href="#cb14-7" tabindex="-1"></a>color_class <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(gcdv3_vegtype, cutpts)</span>
<span id="cb14-8"><a href="#cb14-8" tabindex="-1"></a><span class="fu">plot</span>(pts<span class="sc">$</span>Lon, pts<span class="sc">$</span>Lat, <span class="at">col=</span>plotclr[color_class<span class="sc">+</span><span class="dv">1</span>], <span class="at">pch=</span><span class="dv">16</span>)</span></code></pre></div>
<p>Plot the extracted data at the target points on top of the source
points. If the extraction is successful, the target-point colors should
dissappear against the background.</p>
<div class="sourceCode" id="cb15"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb15-1"><a href="#cb15-1" tabindex="-1"></a>plt <span class="ot">&lt;-</span> <span class="fu">levelplot</span>(vegtype, <span class="at">margin=</span>F, <span class="at">par.settings=</span>mapTheme,</span>
<span id="cb15-2"><a href="#cb15-2" tabindex="-1"></a>                 <span class="at">main=</span><span class="st">&quot;Potential Natural Vegetation&quot;</span>)</span>
<span id="cb15-3"><a href="#cb15-3" tabindex="-1"></a>plotclr <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">8</span>,<span class="st">&quot;Greens&quot;</span>))</span>
<span id="cb15-4"><a href="#cb15-4" tabindex="-1"></a></span>
<span id="cb15-5"><a href="#cb15-5" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="dv">0</span>, <span class="dv">2</span>, <span class="dv">4</span>, <span class="dv">6</span>, <span class="dv">8</span>, <span class="dv">10</span>, <span class="dv">12</span>, <span class="dv">14</span>, <span class="dv">16</span>)</span>
<span id="cb15-6"><a href="#cb15-6" tabindex="-1"></a>color_class <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(gcdv3_vegtype, cutpts)</span>
<span id="cb15-7"><a href="#cb15-7" tabindex="-1"></a>plt <span class="sc">+</span> <span class="fu">layer</span>(<span class="fu">sp.points</span>(gcdv3_pts, <span class="at">col=</span>plotclr[color_class], <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.6</span>)) <span class="sc">+</span> </span>
<span id="cb15-8"><a href="#cb15-8" tabindex="-1"></a>  <span class="fu">layer</span>(<span class="fu">sp.points</span>(gcdv3_pts, <span class="at">col=</span><span class="st">&quot;black&quot;</span>, <span class="at">pch=</span><span class="dv">1</span>, <span class="at">cex=</span><span class="fl">0.6</span>))</span></code></pre></div>
<p><a href="geospatial.html">[Back to top]</a></p>
</div>
<div id="a-second-example-explicit-cell-selection"
class="section level2" number="3.3">
<h2><span class="header-section-number">3.3</span> A second example –
explicit cell selection</h2>
<p>Here’s a second example of extracting values from an array, by
referencing the specific cell or array element that a target point falls
in. In this example, a netCDF file of bioclimatic variables is read
using <code>ncdf4</code> and the values of <code>mtco</code> (mean
temperature of the coldest month) are extracted.</p>
<div class="sourceCode" id="cb16"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb16-1"><a href="#cb16-1" tabindex="-1"></a><span class="fu">library</span>(ncdf4)</span>
<span id="cb16-2"><a href="#cb16-2" tabindex="-1"></a><span class="fu">library</span>(classInt)</span>
<span id="cb16-3"><a href="#cb16-3" tabindex="-1"></a><span class="fu">library</span>(RColorBrewer)</span></code></pre></div>
<div class="sourceCode" id="cb17"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb17-1"><a href="#cb17-1" tabindex="-1"></a><span class="co"># set path and filename</span></span>
<span id="cb17-2"><a href="#cb17-2" tabindex="-1"></a>ncpath <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb17-3"><a href="#cb17-3" tabindex="-1"></a>ncname <span class="ot">&lt;-</span> <span class="st">&quot;cru10min30_bio.nc&quot;</span>  </span>
<span id="cb17-4"><a href="#cb17-4" tabindex="-1"></a>ncfname <span class="ot">&lt;-</span> <span class="fu">paste</span>(ncpath, ncname, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span></code></pre></div>
<div class="sourceCode" id="cb18"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb18-1"><a href="#cb18-1" tabindex="-1"></a><span class="co"># open a netCDF file</span></span>
<span id="cb18-2"><a href="#cb18-2" tabindex="-1"></a>ncin <span class="ot">&lt;-</span> <span class="fu">nc_open</span>(ncfname)</span>
<span id="cb18-3"><a href="#cb18-3" tabindex="-1"></a><span class="fu">print</span>(ncin)</span></code></pre></div>
<div class="sourceCode" id="cb19"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb19-1"><a href="#cb19-1" tabindex="-1"></a><span class="co"># get longitude and latitude</span></span>
<span id="cb19-2"><a href="#cb19-2" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lon&quot;</span>)</span>
<span id="cb19-3"><a href="#cb19-3" tabindex="-1"></a>nlon <span class="ot">&lt;-</span> <span class="fu">dim</span>(lon)</span>
<span id="cb19-4"><a href="#cb19-4" tabindex="-1"></a><span class="fu">head</span>(lon)</span>
<span id="cb19-5"><a href="#cb19-5" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lat&quot;</span>)</span>
<span id="cb19-6"><a href="#cb19-6" tabindex="-1"></a>nlat <span class="ot">&lt;-</span> <span class="fu">dim</span>(lat)</span>
<span id="cb19-7"><a href="#cb19-7" tabindex="-1"></a><span class="fu">head</span>(lat)</span>
<span id="cb19-8"><a href="#cb19-8" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(nlon,nlat))</span></code></pre></div>
<div class="sourceCode" id="cb20"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb20-1"><a href="#cb20-1" tabindex="-1"></a><span class="co"># get the mtco data</span></span>
<span id="cb20-2"><a href="#cb20-2" tabindex="-1"></a>mtco <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;mtco&quot;</span>)</span>
<span id="cb20-3"><a href="#cb20-3" tabindex="-1"></a>dlname <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="st">&quot;mtco&quot;</span>,<span class="st">&quot;long_name&quot;</span>)</span>
<span id="cb20-4"><a href="#cb20-4" tabindex="-1"></a>dunits <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="st">&quot;mtco&quot;</span>,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb20-5"><a href="#cb20-5" tabindex="-1"></a>fillvalue <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="st">&quot;mtco&quot;</span>,<span class="st">&quot;_FillValue&quot;</span>)</span>
<span id="cb20-6"><a href="#cb20-6" tabindex="-1"></a><span class="fu">dim</span>(mtco)</span></code></pre></div>
<div class="sourceCode" id="cb21"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb21-1"><a href="#cb21-1" tabindex="-1"></a>mtco[mtco<span class="sc">==</span>fillvalue<span class="sc">$</span>value] <span class="ot">&lt;-</span> <span class="cn">NA</span></span></code></pre></div>
<p>Close the netCDF file using the <code>nc_close()</code> function.</p>
<div class="sourceCode" id="cb22"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb22-1"><a href="#cb22-1" tabindex="-1"></a><span class="co"># close the netCDF file</span></span>
<span id="cb22-2"><a href="#cb22-2" tabindex="-1"></a><span class="fu">nc_close</span>(ncin)</span></code></pre></div>
<p>Plot the control data.</p>
<div class="sourceCode" id="cb23"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb23-1"><a href="#cb23-1" tabindex="-1"></a><span class="co"># levelplot of the slice</span></span>
<span id="cb23-2"><a href="#cb23-2" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lon=</span>lon, <span class="at">lat=</span>lat)</span>
<span id="cb23-3"><a href="#cb23-3" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">50</span>,<span class="sc">-</span><span class="dv">40</span>,<span class="sc">-</span><span class="dv">30</span>,<span class="sc">-</span><span class="dv">20</span>,<span class="sc">-</span><span class="dv">10</span>,<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>)</span>
<span id="cb23-4"><a href="#cb23-4" tabindex="-1"></a><span class="fu">levelplot</span>(mtco <span class="sc">~</span> lon <span class="sc">*</span> lat, <span class="at">data=</span>grid, <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb23-5"><a href="#cb23-5" tabindex="-1"></a>  <span class="at">col.regions=</span>(<span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">10</span>,<span class="st">&quot;RdBu&quot;</span>))))</span></code></pre></div>
<p>Now extract the data for the target points:</p>
<p>Get the indices (j’s and k’s) of the grid cell that each target point
lies in. For each target point, figure out which column (<code>j</code>)
and row (<code>k</code>) a target point falls in. This code is basically
the same as that used in reshaping a “short” data frame into an array.
The function that is defined and executed within the
<code>sapply()</code> function figures out which column (<code>j</code>)
and row (‘k’) in the control-data array a target point falls in. The
<code>j</code>’s and <code>k</code>’s together describe the control-data
grid cells the individual target points fall in.</p>
<div class="sourceCode" id="cb24"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb24-1"><a href="#cb24-1" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="fu">sapply</span>(gcdv3<span class="sc">$</span>Lon, <span class="cf">function</span>(x) <span class="fu">which.min</span>(<span class="fu">abs</span>(lon<span class="sc">-</span>x)))</span>
<span id="cb24-2"><a href="#cb24-2" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">sapply</span>(gcdv3<span class="sc">$</span>Lat, <span class="cf">function</span>(x) <span class="fu">which.min</span>(<span class="fu">abs</span>(lat<span class="sc">-</span>x)))</span>
<span id="cb24-3"><a href="#cb24-3" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">cbind</span>(j,k)); <span class="fu">tail</span>(<span class="fu">cbind</span>(j,k))</span></code></pre></div>
<p>Get the data for each j, k combination. The way to do this is the
convert the <code>mtco</code> array to a vector, and then calculate an
index <code>jk</code> for each target value:</p>
<div class="sourceCode" id="cb25"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb25-1"><a href="#cb25-1" tabindex="-1"></a>mtco_vec <span class="ot">&lt;-</span> <span class="fu">as.vector</span>(mtco)</span>
<span id="cb25-2"><a href="#cb25-2" tabindex="-1"></a>jk <span class="ot">&lt;-</span> (k<span class="dv">-1</span>)<span class="sc">*</span>nlon <span class="sc">+</span> j</span>
<span id="cb25-3"><a href="#cb25-3" tabindex="-1"></a>gcdv3_mtco <span class="ot">&lt;-</span> mtco_vec[jk]</span>
<span id="cb25-4"><a href="#cb25-4" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">cbind</span>(j,k,jk,gcdv3_mtco,lon[j],lat[k]))</span></code></pre></div>
<div class="sourceCode" id="cb26"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb26-1"><a href="#cb26-1" tabindex="-1"></a>gcdv3_mtco[<span class="fu">is.na</span>(gcdv3_mtco)] <span class="ot">&lt;-</span> <span class="sc">-</span><span class="dv">99</span></span>
<span id="cb26-2"><a href="#cb26-2" tabindex="-1"></a>pts <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(gcdv3<span class="sc">$</span>Lon, gcdv3<span class="sc">$</span>Lat, gcdv3_mtco)</span>
<span id="cb26-3"><a href="#cb26-3" tabindex="-1"></a><span class="fu">names</span>(pts) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;Lon&quot;</span>, <span class="st">&quot;Lat&quot;</span>, <span class="st">&quot;mtco&quot;</span>)</span>
<span id="cb26-4"><a href="#cb26-4" tabindex="-1"></a><span class="fu">head</span>(pts, <span class="dv">20</span>)</span></code></pre></div>
<p>Plot the extracted values of <code>mtco</code>. To do this, the
colors for plotting the different levels of <code>mtco</code> are
generated from and <code>RColorBrewer</code> palette, and augmented by
gray (<code>"#AAAAAA"</code>) to handle missing values (i.e. from marine
charcoal records, or those from sites “off” the cru10min30 grid).</p>
<div class="sourceCode" id="cb27"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb27-1"><a href="#cb27-1" tabindex="-1"></a>plotclr <span class="ot">&lt;-</span> <span class="fu">rev</span>(<span class="fu">brewer.pal</span>(<span class="dv">10</span>,<span class="st">&quot;RdBu&quot;</span>))</span>
<span id="cb27-2"><a href="#cb27-2" tabindex="-1"></a>plotclr <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;#AAAAAA&quot;</span>, plotclr)</span>
<span id="cb27-3"><a href="#cb27-3" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">50</span>,<span class="sc">-</span><span class="dv">40</span>,<span class="sc">-</span><span class="dv">30</span>,<span class="sc">-</span><span class="dv">20</span>,<span class="sc">-</span><span class="dv">10</span>,<span class="dv">0</span>,<span class="dv">10</span>,<span class="dv">20</span>,<span class="dv">30</span>,<span class="dv">40</span>,<span class="dv">50</span>)</span>
<span id="cb27-4"><a href="#cb27-4" tabindex="-1"></a>color_class <span class="ot">&lt;-</span> <span class="fu">findInterval</span>(gcdv3_mtco, cutpts)</span>
<span id="cb27-5"><a href="#cb27-5" tabindex="-1"></a><span class="fu">plot</span>(gcdv3<span class="sc">$</span>Lon, gcdv3<span class="sc">$</span>Lat, <span class="at">col=</span>plotclr[color_class<span class="sc">+</span><span class="dv">1</span>], <span class="at">pch=</span><span class="dv">16</span>)</span></code></pre></div>
<p><a href="geospatial.html">[Back to top]</a></p>
</div>
</div>
<div id="clippingtrimmingpoint-in-polygon-analyses"
class="section level1" number="4">
<h1><span class="header-section-number">4</span>
Clipping/Trimming/Point-in-polygon analyses</h1>
<p>A common problem arises in dealing with spatial data is the
“clipping” or “trimming” problem, in which one wants to know whether one
or more points lie within the outlines of a particular polygon, or in
the case of multiple polygons, which polygon an individual point lies
in. More formally, this is known as the “point in polygon” problem. Here
the process of clipping the na_10km_v2 climate grid to a tree-species
shape file, in particular, that for <em>Picea mariana</em> (black
spruce) is demonstrated. What we want is a list of climate data set
points that lie withing the range of <em>P. mariana</em>.</p>
<div id="read-the-polygon-and-target-point-files" class="section level2"
number="4.1">
<h2><span class="header-section-number">4.1</span> Read the polygon and
target-point files</h2>
<div class="sourceCode" id="cb28"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb28-1"><a href="#cb28-1" tabindex="-1"></a><span class="fu">library</span>(rgeos)</span></code></pre></div>
<p>Read the shapefile for <em>Picea mariana</em></p>
<div class="sourceCode" id="cb29"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb29-1"><a href="#cb29-1" tabindex="-1"></a><span class="co"># read the shape file for Picea Mariana</span></span>
<span id="cb29-2"><a href="#cb29-2" tabindex="-1"></a>shp_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/shp_files/USGS_pp1650/&quot;</span></span>
<span id="cb29-3"><a href="#cb29-3" tabindex="-1"></a>shp_name <span class="ot">&lt;-</span> <span class="st">&quot;picemari.shp&quot;</span></span>
<span id="cb29-4"><a href="#cb29-4" tabindex="-1"></a>shp_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(shp_path, shp_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb29-5"><a href="#cb29-5" tabindex="-1"></a>picea_shp <span class="ot">&lt;-</span> <span class="fu">readOGR</span>(shp_file)</span></code></pre></div>
<p>Add a coordinate refernce system to the shapefile, and plot it:</p>
<div class="sourceCode" id="cb30"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb30-1"><a href="#cb30-1" tabindex="-1"></a><span class="fu">proj4string</span>(picea_shp) <span class="ot">=</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb30-2"><a href="#cb30-2" tabindex="-1"></a><span class="fu">class</span>(picea_shp)</span>
<span id="cb30-3"><a href="#cb30-3" tabindex="-1"></a><span class="fu">plot</span>(picea_shp)</span></code></pre></div>
<p>Read the na10km_v2 points as a .csv file (for illustration, in
practice it would be more efficient to read it as a netCDF file).</p>
<div class="sourceCode" id="cb31"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb31-1"><a href="#cb31-1" tabindex="-1"></a><span class="co"># read the na10km_v2 points (as a .csv file)</span></span>
<span id="cb31-2"><a href="#cb31-2" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/csv_files/&quot;</span></span>
<span id="cb31-3"><a href="#cb31-3" tabindex="-1"></a>csv_name <span class="ot">&lt;-</span> <span class="st">&quot;na10km_v2.csv&quot;</span></span>
<span id="cb31-4"><a href="#cb31-4" tabindex="-1"></a>csv_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(csv_path, csv_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb31-5"><a href="#cb31-5" tabindex="-1"></a>na10km_v2 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(csv_file)</span>
<span id="cb31-6"><a href="#cb31-6" tabindex="-1"></a><span class="fu">str</span>(na10km_v2)</span></code></pre></div>
<p>For convenience in display (because the na10km_v2 grid includes
Europe and wraps around the dateline), reduce it to only the points west
of 45W:</p>
<div class="sourceCode" id="cb32"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb32-1"><a href="#cb32-1" tabindex="-1"></a>na10km_v2 <span class="ot">&lt;-</span> na10km_v2[na10km_v2<span class="sc">$</span>lon <span class="sc">&lt;=</span> <span class="sc">-</span><span class="fl">45.0</span>, ]</span></code></pre></div>
<p>Make a <code>SpatialPointsDataFrame</code> of the na10km_v2
data-point locations, and plot it:</p>
<div class="sourceCode" id="cb33"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb33-1"><a href="#cb33-1" tabindex="-1"></a><span class="co"># make a SpatialPointsDataFrame</span></span>
<span id="cb33-2"><a href="#cb33-2" tabindex="-1"></a>na10km_v2_coords <span class="ot">&lt;-</span> <span class="fu">cbind</span>(na10km_v2<span class="sc">$</span>lon, na10km_v2<span class="sc">$</span>lat)</span>
<span id="cb33-3"><a href="#cb33-3" tabindex="-1"></a>na10km_v2_pts <span class="ot">&lt;-</span> <span class="fu">SpatialPoints</span>(<span class="at">coords=</span>na10km_v2_coords, <span class="at">proj4string =</span> <span class="fu">CRS</span>(<span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>))</span>
<span id="cb33-4"><a href="#cb33-4" tabindex="-1"></a><span class="fu">class</span>(na10km_v2_pts)</span>
<span id="cb33-5"><a href="#cb33-5" tabindex="-1"></a><span class="fu">plot</span>(na10km_v2_pts, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.4</span>)</span></code></pre></div>
</div>
<div id="overlay-the-points-onto-the-polygons" class="section level2"
number="4.2">
<h2><span class="header-section-number">4.2</span> Overlay the points
onto the polygons</h2>
<p>Now overlay the points onto the polygons. Note that the input shape
file was a <code>SpatialPolygonsDataFrame</code> object, so convert it
to a simpler “SpatialPolygons” file first. The <code>over()</code>
function from <code>rgeos</code> takes a little while to run.</p>
<div class="sourceCode" id="cb34"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb34-1"><a href="#cb34-1" tabindex="-1"></a><span class="co"># overlay the two shape files</span></span>
<span id="cb34-2"><a href="#cb34-2" tabindex="-1"></a>picea_poly <span class="ot">&lt;-</span> <span class="fu">as</span>(picea_shp, <span class="st">&quot;SpatialPolygons&quot;</span>)</span>
<span id="cb34-3"><a href="#cb34-3" tabindex="-1"></a><span class="fu">class</span>(picea_poly)</span>
<span id="cb34-4"><a href="#cb34-4" tabindex="-1"></a>picea_pts <span class="ot">&lt;-</span> <span class="fu">over</span>(na10km_v2_pts, picea_poly)</span>
<span id="cb34-5"><a href="#cb34-5" tabindex="-1"></a><span class="fu">class</span>(picea_pts)</span></code></pre></div>
<p>Make a dataframe from the “trimmed” points and plot it on top of the
na10km_v2 points:</p>
<div class="sourceCode" id="cb35"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb35-1"><a href="#cb35-1" tabindex="-1"></a>picea_pts2 <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(na10km_v2_coords[<span class="sc">!</span><span class="fu">is.na</span>(picea_pts), ] )</span>
<span id="cb35-2"><a href="#cb35-2" tabindex="-1"></a><span class="fu">plot</span>(na10km_v2_pts, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.4</span>)</span>
<span id="cb35-3"><a href="#cb35-3" tabindex="-1"></a><span class="fu">points</span>(picea_pts2, <span class="at">pch=</span><span class="dv">16</span>, <span class="at">cex=</span><span class="fl">0.1</span>, <span class="at">col=</span><span class="st">&quot;green&quot;</span>)</span></code></pre></div>
<p><a href="geospatial.html">[Back to top]</a></p>
</div>
</div>
<div id="gridding-or-rasterizing-point-data" class="section level1"
number="5">
<h1><span class="header-section-number">5</span> Gridding or rasterizing
point data</h1>
<p>Another common task is to grid or rasterize a set of point data,
creating a gridded data set of counts, averages, minima, maxima, etc.
This can be illustrated using the FPA-FOD daily fire-fire start data
set: Spatial wildfire occurrence data for the United States,
1992-2013/Fire Program Analysis Fire-Occurrence Database
[FPA_FOD_20150323] (3nd Edition) (Short, K.C., 2014, Earth Syst. Sci.
Data, 6, 1-27) – <a
href="http://www.fs.usda.gov/rds/archive/Product/RDS-2013-0009.3/">http://www.fs.usda.gov/rds/archive/Product/RDS-2013-0009.3/</a>.
The idea here is to calculate the number and average area of the fires
that occured in 0.5-degree grid cells that cover the coterminous
U.S.</p>
<div id="read-the-data-sets-and-create-empty-rasters"
class="section level2" number="5.1">
<h2><span class="header-section-number">5.1</span> Read the data sets,
and create empty rasters</h2>
<div class="sourceCode" id="cb36"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb36-1"><a href="#cb36-1" tabindex="-1"></a><span class="fu">library</span>(raster, <span class="at">eval=</span><span class="cn">FALSE</span>)</span>
<span id="cb36-2"><a href="#cb36-2" tabindex="-1"></a><span class="fu">library</span>(rasterVis, <span class="at">eval=</span><span class="cn">FALSE</span>)</span></code></pre></div>
<p>Read the fire-start data:</p>
<div class="sourceCode" id="cb37"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb37-1"><a href="#cb37-1" tabindex="-1"></a><span class="co"># read the FPA-FOD fire-start data</span></span>
<span id="cb37-2"><a href="#cb37-2" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/csv_files/&quot;</span></span>
<span id="cb37-3"><a href="#cb37-3" tabindex="-1"></a>csv_name <span class="ot">&lt;-</span> <span class="st">&quot;fpafod_1992-2013.csv&quot;</span></span>
<span id="cb37-4"><a href="#cb37-4" tabindex="-1"></a>csv_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(csv_path, csv_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb37-5"><a href="#cb37-5" tabindex="-1"></a>fpafod <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(csv_file) <span class="co"># takes a while</span></span>
<span id="cb37-6"><a href="#cb37-6" tabindex="-1"></a><span class="fu">str</span>(fpafod)</span></code></pre></div>
<p>Convert the fire-start data to a
<code>SpatialPointsDataFrame</code></p>
<div class="sourceCode" id="cb38"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb38-1"><a href="#cb38-1" tabindex="-1"></a>fpafod_coords <span class="ot">&lt;-</span> <span class="fu">cbind</span>(fpafod<span class="sc">$</span>longitude, fpafod<span class="sc">$</span>latitude)</span>
<span id="cb38-2"><a href="#cb38-2" tabindex="-1"></a>fpafod_pts <span class="ot">&lt;-</span> <span class="fu">SpatialPointsDataFrame</span>(<span class="at">coords=</span>fpafod_coords, <span class="at">data=</span><span class="fu">data.frame</span>(fpafod<span class="sc">$</span>area_ha))</span>
<span id="cb38-3"><a href="#cb38-3" tabindex="-1"></a><span class="fu">names</span>(fpafod_pts) <span class="ot">&lt;-</span> <span class="st">&quot;area_ha&quot;</span></span></code></pre></div>
<p>Create a couple of empty rasters to hold the rasterized data:</p>
<div class="sourceCode" id="cb39"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb39-1"><a href="#cb39-1" tabindex="-1"></a><span class="co"># create (empty) rasters</span></span>
<span id="cb39-2"><a href="#cb39-2" tabindex="-1"></a>cell_size <span class="ot">&lt;-</span> <span class="fl">0.5</span></span>
<span id="cb39-3"><a href="#cb39-3" tabindex="-1"></a>lon_min <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">128.0</span>; lon_max <span class="ot">&lt;-</span> <span class="sc">-</span><span class="fl">65.0</span>; lat_min <span class="ot">&lt;-</span> <span class="fl">25.5</span>; lat_max <span class="ot">&lt;-</span> <span class="fl">50.5</span></span>
<span id="cb39-4"><a href="#cb39-4" tabindex="-1"></a>ncols <span class="ot">&lt;-</span> ((lon_max <span class="sc">-</span> lon_min)<span class="sc">/</span>cell_size)<span class="sc">+</span><span class="dv">1</span>; nrows <span class="ot">&lt;-</span> ((lat_max <span class="sc">-</span> lat_min)<span class="sc">/</span>cell_size)<span class="sc">+</span><span class="dv">1</span> </span>
<span id="cb39-5"><a href="#cb39-5" tabindex="-1"></a>us_fire_counts <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="at">nrows=</span>nrows, <span class="at">ncols=</span>ncols, <span class="at">xmn=</span>lon_min, <span class="at">xmx=</span>lon_max, <span class="at">ymn=</span>lat_min, <span class="at">ymx=</span>lat_max, <span class="at">res=</span><span class="fl">0.5</span>, <span class="at">crs=</span><span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb39-6"><a href="#cb39-6" tabindex="-1"></a>us_fire_counts</span>
<span id="cb39-7"><a href="#cb39-7" tabindex="-1"></a>us_fire_area <span class="ot">&lt;-</span> <span class="fu">raster</span>(<span class="at">nrows=</span>nrows, <span class="at">ncols=</span>ncols, <span class="at">xmn=</span>lon_min, <span class="at">xmx=</span>lon_max, <span class="at">ymn=</span>lat_min, <span class="at">ymx=</span>lat_max, <span class="at">res=</span><span class="fl">0.5</span>, <span class="at">crs=</span><span class="st">&quot;+proj=longlat +datum=WGS84&quot;</span>)</span>
<span id="cb39-8"><a href="#cb39-8" tabindex="-1"></a>us_fire_area</span></code></pre></div>
</div>
<div id="rasterize-the-data" class="section level2" number="5.2">
<h2><span class="header-section-number">5.2</span> Rasterize the
data</h2>
<p>Now rasterize the data, first as counts (number of fires in each grid
cell), and then as the average size of the fires in each grid cell. Also
plot the data (both on a log10 scale:</p>
<div class="sourceCode" id="cb40"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb40-1"><a href="#cb40-1" tabindex="-1"></a><span class="co"># rasterize</span></span>
<span id="cb40-2"><a href="#cb40-2" tabindex="-1"></a>us_fire_counts <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(fpafod_coords, us_fire_counts, <span class="at">fun=</span><span class="st">&quot;count&quot;</span>)</span>
<span id="cb40-3"><a href="#cb40-3" tabindex="-1"></a>us_fire_counts</span>
<span id="cb40-4"><a href="#cb40-4" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log10</span>(us_fire_counts), <span class="at">col=</span><span class="fu">brewer.pal</span>(<span class="dv">9</span>,<span class="st">&quot;BuPu&quot;</span>), <span class="at">sub=</span><span class="st">&quot;log10 Number of Fires&quot;</span>)</span>
<span id="cb40-5"><a href="#cb40-5" tabindex="-1"></a></span>
<span id="cb40-6"><a href="#cb40-6" tabindex="-1"></a>us_fire_area <span class="ot">&lt;-</span> <span class="fu">rasterize</span>(fpafod_pts, us_fire_area, <span class="at">fun=</span>mean)</span>
<span id="cb40-7"><a href="#cb40-7" tabindex="-1"></a>us_fire_area</span>
<span id="cb40-8"><a href="#cb40-8" tabindex="-1"></a><span class="fu">plot</span>(<span class="fu">log10</span>(us_fire_area<span class="sc">$</span>area_ha), <span class="at">col=</span><span class="fu">brewer.pal</span>(<span class="dv">9</span>,<span class="st">&quot;YlOrRd&quot;</span>), <span class="at">sub=</span><span class="st">&quot;log10 Mean Area&quot;</span>)</span></code></pre></div>
</div>
<div id="write-the-rasterized-data-out-as-a-netcdf-file"
class="section level2" number="5.3">
<h2><span class="header-section-number">5.3</span> Write the rasterized
data out as a netCDF file</h2>
<p>Write the two rasterized data sets out as variables in a netCDF data
set. Create some variables, and replace the R <code>NAs</code> with
netCDF fillvalues:</p>
<div class="sourceCode" id="cb41"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb41-1"><a href="#cb41-1" tabindex="-1"></a><span class="co"># make necessary vectors and arrays</span></span>
<span id="cb41-2"><a href="#cb41-2" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">seq</span>(lon_min<span class="fl">+0.25</span>, lon_max<span class="fl">-0.25</span>, <span class="at">by=</span>cell_size)</span>
<span id="cb41-3"><a href="#cb41-3" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">seq</span>(lat_max<span class="fl">-0.25</span>, lat_min<span class="fl">+0.25</span>, <span class="at">by=</span><span class="sc">-</span><span class="dv">1</span><span class="sc">*</span>cell_size)</span>
<span id="cb41-4"><a href="#cb41-4" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(<span class="fu">length</span>(lon), <span class="fu">length</span>(lat)))</span>
<span id="cb41-5"><a href="#cb41-5" tabindex="-1"></a></span>
<span id="cb41-6"><a href="#cb41-6" tabindex="-1"></a>fillvalue <span class="ot">&lt;-</span> <span class="fl">1e32</span></span>
<span id="cb41-7"><a href="#cb41-7" tabindex="-1"></a>us_fire_counts2 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">as.matrix</span>(us_fire_counts<span class="sc">$</span>layer, <span class="at">nrows=</span>ncols, <span class="at">ncols=</span>nrows))</span>
<span id="cb41-8"><a href="#cb41-8" tabindex="-1"></a><span class="fu">dim</span>(us_fire_counts2)</span>
<span id="cb41-9"><a href="#cb41-9" tabindex="-1"></a>us_fire_counts2[<span class="fu">is.na</span>(us_fire_counts2)] <span class="ot">&lt;-</span> fillvalue</span>
<span id="cb41-10"><a href="#cb41-10" tabindex="-1"></a></span>
<span id="cb41-11"><a href="#cb41-11" tabindex="-1"></a>us_fire_area2 <span class="ot">&lt;-</span> <span class="fu">t</span>(<span class="fu">as.matrix</span>(us_fire_area<span class="sc">$</span>area_ha, <span class="at">nrows=</span>ncols, <span class="at">ncols=</span>nrows))</span>
<span id="cb41-12"><a href="#cb41-12" tabindex="-1"></a><span class="fu">dim</span>(us_fire_area2)</span>
<span id="cb41-13"><a href="#cb41-13" tabindex="-1"></a>us_fire_area2[<span class="fu">is.na</span>(us_fire_area2)] <span class="ot">&lt;-</span> fillvalue</span></code></pre></div>
<p>Write out a netCDF file:</p>
<div class="sourceCode" id="cb42"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb42-1"><a href="#cb42-1" tabindex="-1"></a><span class="co"># write out a netCDF file</span></span>
<span id="cb42-2"><a href="#cb42-2" tabindex="-1"></a><span class="fu">library</span>(ncdf4)</span>
<span id="cb42-3"><a href="#cb42-3" tabindex="-1"></a></span>
<span id="cb42-4"><a href="#cb42-4" tabindex="-1"></a><span class="co"># path and file name, set dname</span></span>
<span id="cb42-5"><a href="#cb42-5" tabindex="-1"></a>ncpath <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb42-6"><a href="#cb42-6" tabindex="-1"></a>ncname <span class="ot">&lt;-</span> <span class="st">&quot;us_fires.nc&quot;</span>  </span>
<span id="cb42-7"><a href="#cb42-7" tabindex="-1"></a>ncfname <span class="ot">&lt;-</span> <span class="fu">paste</span>(ncpath, ncname, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb42-8"><a href="#cb42-8" tabindex="-1"></a></span>
<span id="cb42-9"><a href="#cb42-9" tabindex="-1"></a><span class="co"># create and write the netCDF file -- ncdf4 version</span></span>
<span id="cb42-10"><a href="#cb42-10" tabindex="-1"></a><span class="co"># define dimensions</span></span>
<span id="cb42-11"><a href="#cb42-11" tabindex="-1"></a>londim <span class="ot">&lt;-</span> <span class="fu">ncdim_def</span>(<span class="st">&quot;lon&quot;</span>,<span class="st">&quot;degrees_east&quot;</span>,<span class="fu">as.double</span>(lon)) </span>
<span id="cb42-12"><a href="#cb42-12" tabindex="-1"></a>latdim <span class="ot">&lt;-</span> <span class="fu">ncdim_def</span>(<span class="st">&quot;lat&quot;</span>,<span class="st">&quot;degrees_north&quot;</span>,<span class="fu">as.double</span>(lat)) </span>
<span id="cb42-13"><a href="#cb42-13" tabindex="-1"></a></span>
<span id="cb42-14"><a href="#cb42-14" tabindex="-1"></a><span class="co"># define variables</span></span>
<span id="cb42-15"><a href="#cb42-15" tabindex="-1"></a></span>
<span id="cb42-16"><a href="#cb42-16" tabindex="-1"></a>dname <span class="ot">&lt;-</span> <span class="st">&quot;fpafod_counts&quot;</span> </span>
<span id="cb42-17"><a href="#cb42-17" tabindex="-1"></a>dlname <span class="ot">&lt;-</span> <span class="st">&quot;Number of fires, 1992-2013&quot;</span></span>
<span id="cb42-18"><a href="#cb42-18" tabindex="-1"></a>v1_def <span class="ot">&lt;-</span> <span class="fu">ncvar_def</span>(dname,<span class="st">&quot;1&quot;</span>,<span class="fu">list</span>(londim,latdim),fillvalue,dlname,<span class="at">prec=</span><span class="st">&quot;single&quot;</span>)</span>
<span id="cb42-19"><a href="#cb42-19" tabindex="-1"></a>dname <span class="ot">&lt;-</span> <span class="st">&quot;fpafod_mean_area&quot;</span> </span>
<span id="cb42-20"><a href="#cb42-20" tabindex="-1"></a>dlname <span class="ot">&lt;-</span> <span class="st">&quot;Average Fire Size, 1992-2013&quot;</span></span>
<span id="cb42-21"><a href="#cb42-21" tabindex="-1"></a>v2_def <span class="ot">&lt;-</span> <span class="fu">ncvar_def</span>(dname,<span class="st">&quot;ha&quot;</span>,<span class="fu">list</span>(londim,latdim),fillvalue,dlname,<span class="at">prec=</span><span class="st">&quot;single&quot;</span>)</span>
<span id="cb42-22"><a href="#cb42-22" tabindex="-1"></a></span>
<span id="cb42-23"><a href="#cb42-23" tabindex="-1"></a><span class="co"># create netCDF file and put arrays</span></span>
<span id="cb42-24"><a href="#cb42-24" tabindex="-1"></a>ncout <span class="ot">&lt;-</span> <span class="fu">nc_create</span>(ncfname,<span class="fu">list</span>(v1_def, v2_def),<span class="at">force_v4=</span><span class="cn">TRUE</span>)</span>
<span id="cb42-25"><a href="#cb42-25" tabindex="-1"></a></span>
<span id="cb42-26"><a href="#cb42-26" tabindex="-1"></a><span class="co"># put variables</span></span>
<span id="cb42-27"><a href="#cb42-27" tabindex="-1"></a><span class="fu">ncvar_put</span>(ncout,v1_def,us_fire_counts2)</span>
<span id="cb42-28"><a href="#cb42-28" tabindex="-1"></a><span class="fu">ncvar_put</span>(ncout,v2_def,us_fire_area2)</span>
<span id="cb42-29"><a href="#cb42-29" tabindex="-1"></a></span>
<span id="cb42-30"><a href="#cb42-30" tabindex="-1"></a><span class="co"># put additional attributes into dimension and data variables</span></span>
<span id="cb42-31"><a href="#cb42-31" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="st">&quot;lon&quot;</span>,<span class="st">&quot;axis&quot;</span>,<span class="st">&quot;X&quot;</span>) </span>
<span id="cb42-32"><a href="#cb42-32" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="st">&quot;lat&quot;</span>,<span class="st">&quot;axis&quot;</span>,<span class="st">&quot;Y&quot;</span>)</span>
<span id="cb42-33"><a href="#cb42-33" tabindex="-1"></a></span>
<span id="cb42-34"><a href="#cb42-34" tabindex="-1"></a><span class="co"># add global attributes</span></span>
<span id="cb42-35"><a href="#cb42-35" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="dv">0</span>,<span class="st">&quot;title&quot;</span>,<span class="st">&quot;FPA-FOD Fires&quot;</span>)</span>
<span id="cb42-36"><a href="#cb42-36" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="dv">0</span>,<span class="st">&quot;institution&quot;</span>,<span class="st">&quot;USFS&quot;</span>)</span>
<span id="cb42-37"><a href="#cb42-37" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="dv">0</span>,<span class="st">&quot;source&quot;</span>,<span class="st">&quot;http://www.fs.usda.gov/rds/archive/Product/RDS-2013-0009.3/&quot;</span>)</span>
<span id="cb42-38"><a href="#cb42-38" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="dv">0</span>,<span class="st">&quot;references&quot;</span>, <span class="st">&quot;Short, K.C., 2014, Earth Syst. Sci. Data, 6, 1-27&quot;</span>)</span>
<span id="cb42-39"><a href="#cb42-39" tabindex="-1"></a>history <span class="ot">&lt;-</span> <span class="fu">paste</span>(<span class="st">&quot;P.J. Bartlein&quot;</span>, <span class="fu">date</span>(), <span class="at">sep=</span><span class="st">&quot;, &quot;</span>)</span>
<span id="cb42-40"><a href="#cb42-40" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="dv">0</span>,<span class="st">&quot;history&quot;</span>,history)</span>
<span id="cb42-41"><a href="#cb42-41" tabindex="-1"></a><span class="fu">ncatt_put</span>(ncout,<span class="dv">0</span>,<span class="st">&quot;Conventions&quot;</span>,<span class="st">&quot;CF-1.6&quot;</span>)</span>
<span id="cb42-42"><a href="#cb42-42" tabindex="-1"></a></span>
<span id="cb42-43"><a href="#cb42-43" tabindex="-1"></a><span class="co"># Get a summary of the created file:</span></span>
<span id="cb42-44"><a href="#cb42-44" tabindex="-1"></a>ncout</span>
<span id="cb42-45"><a href="#cb42-45" tabindex="-1"></a></span>
<span id="cb42-46"><a href="#cb42-46" tabindex="-1"></a><span class="co"># close the file, writing data to disk</span></span>
<span id="cb42-47"><a href="#cb42-47" tabindex="-1"></a><span class="fu">nc_close</span>(ncout)</span></code></pre></div>
<p><a href="geospatial.html">[Back to top]</a></p>
</div>
</div>
<div id="interpolatingregridding" class="section level1" number="6">
<h1><span class="header-section-number">6</span>
Interpolating/regridding</h1>
<p>Another common task involves tranferring values from one gridded data
set to another. When the grids are identical, this is trivial, but when
the “target” grid is different from the source or “control” grid, this
involves interpolation (as does also the case when the target points are
irregularly distributed). The most widely used method for interpolation
within a control grid is <em>bilinear interpolation</em>, which involves
finding the control grid points that surround a particular target point,
and then simultaneously (linearlly) interplating in the x- and
y-directions. The method is implemented in the <code>raster</code>
package, and relatively fast version is implemented in the
<code>fields</code> package.</p>
<p>The example here uses a lower-resolution verions of the
<code>ETOPO1</code> global DEM as the source file, and the locations of
the (land-only) points in the na10km_v2 grid as the targets. These are
read in here from a .csv file, but they also could have come from a
netCDF file.</p>
<div id="open-the-control-netcdf-and-target-.csv-files"
class="section level2" number="6.1">
<h2><span class="header-section-number">6.1</span> Open the “control”
netCDF and target .csv files</h2>
<p>Load the appropriate packages.</p>
<div class="sourceCode" id="cb43"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb43-1"><a href="#cb43-1" tabindex="-1"></a><span class="co"># load the ncdf4 package</span></span>
<span id="cb43-2"><a href="#cb43-2" tabindex="-1"></a><span class="fu">library</span>(ncdf4)</span>
<span id="cb43-3"><a href="#cb43-3" tabindex="-1"></a><span class="fu">library</span>(lattice)</span>
<span id="cb43-4"><a href="#cb43-4" tabindex="-1"></a><span class="fu">library</span>(fields)</span></code></pre></div>
<p>Read the etopo1 netCDF file. This particular file is one in which the
original 30-sec data have been aggregated (by averaging) to six minutes
or one-tenth of a degree (to speed up the execution of the examples). In
practice, one would work with the original higher resolution data. Do
some setup an open the file, and list its contents.</p>
<div class="sourceCode" id="cb44"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb44-1"><a href="#cb44-1" tabindex="-1"></a><span class="co"># set path and filename</span></span>
<span id="cb44-2"><a href="#cb44-2" tabindex="-1"></a>ncpath <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/nc_files/&quot;</span></span>
<span id="cb44-3"><a href="#cb44-3" tabindex="-1"></a>ncname <span class="ot">&lt;-</span> <span class="st">&quot;etopo1_ig_06min.nc&quot;</span>  </span>
<span id="cb44-4"><a href="#cb44-4" tabindex="-1"></a>ncfname <span class="ot">&lt;-</span> <span class="fu">paste</span>(ncpath, ncname,  <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb44-5"><a href="#cb44-5" tabindex="-1"></a>dname <span class="ot">&lt;-</span> <span class="st">&quot;elev&quot;</span>  </span></code></pre></div>
<div class="sourceCode" id="cb45"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb45-1"><a href="#cb45-1" tabindex="-1"></a><span class="co"># open a netCDF file</span></span>
<span id="cb45-2"><a href="#cb45-2" tabindex="-1"></a>ncin <span class="ot">&lt;-</span> <span class="fu">nc_open</span>(ncfname)</span>
<span id="cb45-3"><a href="#cb45-3" tabindex="-1"></a><span class="fu">print</span>(ncin)</span></code></pre></div>
<p>Get the “control” longitudes and latitudes.</p>
<div class="sourceCode" id="cb46"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb46-1"><a href="#cb46-1" tabindex="-1"></a><span class="co"># get longitude and latitude</span></span>
<span id="cb46-2"><a href="#cb46-2" tabindex="-1"></a>lon <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lon&quot;</span>)</span>
<span id="cb46-3"><a href="#cb46-3" tabindex="-1"></a>nlon <span class="ot">&lt;-</span> <span class="fu">dim</span>(lon)</span>
<span id="cb46-4"><a href="#cb46-4" tabindex="-1"></a><span class="fu">head</span>(lon)</span>
<span id="cb46-5"><a href="#cb46-5" tabindex="-1"></a>lat <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,<span class="st">&quot;lat&quot;</span>)</span>
<span id="cb46-6"><a href="#cb46-6" tabindex="-1"></a>nlat <span class="ot">&lt;-</span> <span class="fu">dim</span>(lat)</span>
<span id="cb46-7"><a href="#cb46-7" tabindex="-1"></a><span class="fu">head</span>(lat)</span>
<span id="cb46-8"><a href="#cb46-8" tabindex="-1"></a><span class="fu">print</span>(<span class="fu">c</span>(nlon,nlat))</span></code></pre></div>
<p>Now read the elevations, and various attributes:</p>
<div class="sourceCode" id="cb47"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb47-1"><a href="#cb47-1" tabindex="-1"></a><span class="co"># get elevations</span></span>
<span id="cb47-2"><a href="#cb47-2" tabindex="-1"></a>etopo1_array <span class="ot">&lt;-</span> <span class="fu">ncvar_get</span>(ncin,dname)</span>
<span id="cb47-3"><a href="#cb47-3" tabindex="-1"></a>dlname <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname,<span class="st">&quot;long_name&quot;</span>)</span>
<span id="cb47-4"><a href="#cb47-4" tabindex="-1"></a>dunits <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname,<span class="st">&quot;units&quot;</span>)</span>
<span id="cb47-5"><a href="#cb47-5" tabindex="-1"></a>fillvalue <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,dname,<span class="st">&quot;_FillValue&quot;</span>)</span>
<span id="cb47-6"><a href="#cb47-6" tabindex="-1"></a>dsource <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin, <span class="st">&quot;elev&quot;</span>, <span class="st">&quot;source&quot;</span>)</span>
<span id="cb47-7"><a href="#cb47-7" tabindex="-1"></a><span class="fu">dim</span>(etopo1_array)</span></code></pre></div>
<div class="sourceCode" id="cb48"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb48-1"><a href="#cb48-1" tabindex="-1"></a><span class="co"># get global attributes</span></span>
<span id="cb48-2"><a href="#cb48-2" tabindex="-1"></a>title <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="dv">0</span>,<span class="st">&quot;title&quot;</span>)</span>
<span id="cb48-3"><a href="#cb48-3" tabindex="-1"></a>institution <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="dv">0</span>,<span class="st">&quot;institution&quot;</span>)</span>
<span id="cb48-4"><a href="#cb48-4" tabindex="-1"></a>datasource <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="dv">0</span>,<span class="st">&quot;source&quot;</span>)</span>
<span id="cb48-5"><a href="#cb48-5" tabindex="-1"></a>history <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="dv">0</span>,<span class="st">&quot;history&quot;</span>)</span>
<span id="cb48-6"><a href="#cb48-6" tabindex="-1"></a>Conventions <span class="ot">&lt;-</span> <span class="fu">ncatt_get</span>(ncin,<span class="dv">0</span>,<span class="st">&quot;Conventions&quot;</span>)</span></code></pre></div>
<p>Close the netCDF file using the <code>nc_close()</code> function.</p>
<div class="sourceCode" id="cb49"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb49-1"><a href="#cb49-1" tabindex="-1"></a><span class="co"># close the netCDF file</span></span>
<span id="cb49-2"><a href="#cb49-2" tabindex="-1"></a><span class="fu">nc_close</span>(ncin)</span></code></pre></div>
<p>Produce a quick map to check that the data make sense. (<em>Always do
this!</em>)</p>
<div class="sourceCode" id="cb50"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb50-1"><a href="#cb50-1" tabindex="-1"></a><span class="co"># levelplot of elevations</span></span>
<span id="cb50-2"><a href="#cb50-2" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">lon=</span>lon, <span class="at">lat=</span>lat)</span>
<span id="cb50-3"><a href="#cb50-3" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7000</span>, <span class="sc">-</span><span class="dv">6000</span>, <span class="sc">-</span><span class="dv">4000</span>, <span class="sc">-</span><span class="dv">2000</span>, <span class="dv">0</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>, <span class="dv">2000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>, <span class="dv">5000</span>)</span>
<span id="cb50-4"><a href="#cb50-4" tabindex="-1"></a><span class="fu">levelplot</span>(etopo1_array <span class="sc">~</span> lon <span class="sc">*</span> lat, <span class="at">data=</span>grid, <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb50-5"><a href="#cb50-5" tabindex="-1"></a>  <span class="at">col.regions=</span><span class="fu">topo.colors</span>(<span class="dv">12</span>))</span></code></pre></div>
<p>Open and read the .csv file containing the “target”” points.</p>
<div class="sourceCode" id="cb51"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb51-1"><a href="#cb51-1" tabindex="-1"></a><span class="co"># read na10km_v2 grid-point locations -- land-points only</span></span>
<span id="cb51-2"><a href="#cb51-2" tabindex="-1"></a>csv_path <span class="ot">&lt;-</span> <span class="st">&quot;/Users/bartlein/Projects/ESSD/data/csv_files/&quot;</span></span>
<span id="cb51-3"><a href="#cb51-3" tabindex="-1"></a>csv_name <span class="ot">&lt;-</span> <span class="st">&quot;na10km_v2_pts.csv&quot;</span></span>
<span id="cb51-4"><a href="#cb51-4" tabindex="-1"></a>csv_file <span class="ot">&lt;-</span> <span class="fu">paste</span>(csv_path, csv_name, <span class="at">sep=</span><span class="st">&quot;&quot;</span>)</span>
<span id="cb51-5"><a href="#cb51-5" tabindex="-1"></a>na10km_v2 <span class="ot">&lt;-</span> <span class="fu">read.csv</span>(csv_file) </span>
<span id="cb51-6"><a href="#cb51-6" tabindex="-1"></a><span class="fu">str</span>(na10km_v2)</span></code></pre></div>
<p>Get the number of target points:</p>
<div class="sourceCode" id="cb52"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb52-1"><a href="#cb52-1" tabindex="-1"></a><span class="co"># get number of target points</span></span>
<span id="cb52-2"><a href="#cb52-2" tabindex="-1"></a>ntarg <span class="ot">&lt;-</span> <span class="fu">dim</span>(na10km_v2)[<span class="dv">1</span>]</span>
<span id="cb52-3"><a href="#cb52-3" tabindex="-1"></a>ntarg</span></code></pre></div>
</div>
<div id="interpolation" class="section level2" number="6.2">
<h2><span class="header-section-number">6.2</span> Interpolation</h2>
<p>Set up to do the interpolation. Generate x’s and y’s for the target
grid. In practice, these might be read in from a netCDF file. Here we
need them to define an array that will hold the interpolated values.</p>
<div class="sourceCode" id="cb53"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb53-1"><a href="#cb53-1" tabindex="-1"></a><span class="co"># set dimesions of output array, and define &quot;marginal&quot; x- and y-values</span></span>
<span id="cb53-2"><a href="#cb53-2" tabindex="-1"></a>nx <span class="ot">&lt;-</span> <span class="dv">1078</span>; ny <span class="ot">&lt;-</span> <span class="dv">900</span></span>
<span id="cb53-3"><a href="#cb53-3" tabindex="-1"></a>x <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">5770000</span>, <span class="dv">5000000</span>, <span class="at">by=</span><span class="dv">10000</span>)</span>
<span id="cb53-4"><a href="#cb53-4" tabindex="-1"></a>y <span class="ot">&lt;-</span> <span class="fu">seq</span>(<span class="sc">-</span><span class="dv">4510000</span>, <span class="dv">4480000</span>, <span class="at">by=</span><span class="dv">10000</span>)</span>
<span id="cb53-5"><a href="#cb53-5" tabindex="-1"></a></span>
<span id="cb53-6"><a href="#cb53-6" tabindex="-1"></a><span class="co"># define a vector and array that will contiain the interpolated values</span></span>
<span id="cb53-7"><a href="#cb53-7" tabindex="-1"></a>interp_var <span class="ot">&lt;-</span> <span class="fu">rep</span>(<span class="cn">NA</span>, ntarg)</span>
<span id="cb53-8"><a href="#cb53-8" tabindex="-1"></a>interp_mat <span class="ot">&lt;-</span> <span class="fu">array</span>(<span class="cn">NA</span>, <span class="at">dim=</span><span class="fu">c</span>(nx, ny))</span></code></pre></div>
<p>Get the array subscripts for each point. This is similar to the work
done in reshaping a “short” data frame to an array, as in Week 4</p>
<div class="sourceCode" id="cb54"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb54-1"><a href="#cb54-1" tabindex="-1"></a><span class="co"># get array subscripts for each target point</span></span>
<span id="cb54-2"><a href="#cb54-2" tabindex="-1"></a>j <span class="ot">&lt;-</span> <span class="fu">sapply</span>(na10km_v2<span class="sc">$</span>x, <span class="cf">function</span>(c) <span class="fu">which.min</span>(<span class="fu">abs</span>(x<span class="sc">-</span>c)))</span>
<span id="cb54-3"><a href="#cb54-3" tabindex="-1"></a>k <span class="ot">&lt;-</span> <span class="fu">sapply</span>(na10km_v2<span class="sc">$</span>y, <span class="cf">function</span>(c) <span class="fu">which.min</span>(<span class="fu">abs</span>(y<span class="sc">-</span>c)))</span>
<span id="cb54-4"><a href="#cb54-4" tabindex="-1"></a><span class="fu">head</span>(<span class="fu">cbind</span>(j,k,na10km_v2<span class="sc">$</span>lon,na10km_v2<span class="sc">$</span>lat))</span>
<span id="cb54-5"><a href="#cb54-5" tabindex="-1"></a><span class="fu">tail</span>(<span class="fu">cbind</span>(j,k,na10km_v2<span class="sc">$</span>lon,na10km_v2<span class="sc">$</span>lat))</span></code></pre></div>
<p>Now do bilinear interpolation using the <code>fields</code>
package:</p>
<div class="sourceCode" id="cb55"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb55-1"><a href="#cb55-1" tabindex="-1"></a><span class="co"># bilinear interpolation from fields package</span></span>
<span id="cb55-2"><a href="#cb55-2" tabindex="-1"></a>control_dat <span class="ot">&lt;-</span> <span class="fu">list</span>(<span class="at">x=</span>lon, <span class="at">y=</span>lat, <span class="at">z=</span>etopo1_array)</span>
<span id="cb55-3"><a href="#cb55-3" tabindex="-1"></a>interp_var <span class="ot">&lt;-</span> <span class="fu">interp.surface</span>(control_dat, <span class="fu">cbind</span>(na10km_v2<span class="sc">$</span>lon,na10km_v2<span class="sc">$</span>lat))</span>
<span id="cb55-4"><a href="#cb55-4" tabindex="-1"></a></span>
<span id="cb55-5"><a href="#cb55-5" tabindex="-1"></a><span class="co"># put interpolated values into a 2-d array</span></span>
<span id="cb55-6"><a href="#cb55-6" tabindex="-1"></a>interp_mat[<span class="fu">cbind</span>(j,k)] <span class="ot">&lt;-</span> interp_var[<span class="dv">1</span><span class="sc">:</span>ntarg]</span></code></pre></div>
<p>Get a quick map:</p>
<div class="sourceCode" id="cb56"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb56-1"><a href="#cb56-1" tabindex="-1"></a>grid <span class="ot">&lt;-</span> <span class="fu">expand.grid</span>(<span class="at">x=</span>x, <span class="at">y=</span>y)</span>
<span id="cb56-2"><a href="#cb56-2" tabindex="-1"></a>cutpts <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="sc">-</span><span class="dv">7000</span>, <span class="sc">-</span><span class="dv">6000</span>, <span class="sc">-</span><span class="dv">4000</span>, <span class="sc">-</span><span class="dv">2000</span>, <span class="dv">0</span>, <span class="dv">500</span>, <span class="dv">1000</span>, <span class="dv">1500</span>, <span class="dv">2000</span>, <span class="dv">3000</span>, <span class="dv">4000</span>, <span class="dv">5000</span>)</span>
<span id="cb56-3"><a href="#cb56-3" tabindex="-1"></a><span class="fu">levelplot</span>(interp_mat <span class="sc">~</span> x <span class="sc">*</span> y, <span class="at">data=</span>grid, <span class="at">at=</span>cutpts, <span class="at">cuts=</span><span class="dv">11</span>, <span class="at">pretty=</span>T, </span>
<span id="cb56-4"><a href="#cb56-4" tabindex="-1"></a>  <span class="at">col.regions=</span><span class="fu">topo.colors</span>(<span class="dv">12</span>))</span></code></pre></div>
<p>At this point, <code>interp_mat</code> could be written out as a
variable in a netCDF file (along with dimension and attribute data).
Also make a data frame of the interpolated data, which could be written
out as a .csv file:</p>
<div class="sourceCode" id="cb57"><pre class="sourceCode r"><code class="sourceCode r"><span id="cb57-1"><a href="#cb57-1" tabindex="-1"></a><span class="co"># make a dataframe of the interpolated elevations</span></span>
<span id="cb57-2"><a href="#cb57-2" tabindex="-1"></a>out_df <span class="ot">&lt;-</span> <span class="fu">data.frame</span>(<span class="fu">cbind</span>(na10km_v2<span class="sc">$</span>x, na10km_v2<span class="sc">$</span>y, na10km_v2<span class="sc">$</span>lon, na10km_v2<span class="sc">$</span>lat, interp_var))</span>
<span id="cb57-3"><a href="#cb57-3" tabindex="-1"></a><span class="fu">names</span>(out_df) <span class="ot">&lt;-</span> <span class="fu">c</span>(<span class="st">&quot;x&quot;</span>, <span class="st">&quot;y&quot;</span>, <span class="st">&quot;lon&quot;</span>, <span class="st">&quot;lat&quot;</span>, <span class="st">&quot;elev&quot;</span>)</span>
<span id="cb57-4"><a href="#cb57-4" tabindex="-1"></a><span class="fu">head</span>(out_df); <span class="fu">tail</span>(out_df)</span></code></pre></div>
<p><a href="geospatial.html">[Back to top]</a></p>
</div>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open');
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
